<!--
Calculadora de Accidentalidad CIER 2025
Versi√≥n para publicaci√≥n en entornos web est√°ticos (GitHub Pages).
SE ELIMIN√ì LA FUNCIONALIDAD DE LA API DE GEMINI para evitar errores de conexi√≥n/API Key.
Funcionalidades incluidas:
1. Dise√±o profesional (Azul, Blanco, Verde).
2. L√≥gica de clasificaci√≥n TFCPSI basada en percentiles (cuartiles).
3. An√°lisis de Tipolog√≠a de Casos (Pareto) con checkboxes para selecci√≥n m√≥vil.
4. Cuadro de criterios de clasificaci√≥n optimizado para m√≥vil.
-->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora CIER 2025 - Distribuci√≥n & Integradas</title>
    <!-- Carga de Tailwind CSS CDN y configuraci√≥n de colores -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Paleta Sobria: Azul y Blanco como base, Verde como acento
                        'cier-blue': '#22577A', // Azul corporativo profundo
                        'cier-light-blue': '#E6F0F4', // Azul muy claro para fondo de acento
                        'success-dark': '#38A169', // Verde oscuro para √©xito
                        'success-light': '#D4EDDA', // Fondo verde claro
                        'warning-light': '#FFF3CD', // Fondo amarillo claro para advertencias
                        'danger-light': '#F8D7DA', // Fondo rojo claro para necesidad de mejora
                        'accent-blue': '#4A90E2', // Azul intermedio para acentos
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Estilos base del cuerpo */
        body {
            font-family: 'Inter', sans-serif;
            /* Fondo base azul claro */
            background-color: #C8E6F0; 
            min-height: 100vh;
            display: flex;
            /* Alinea al inicio para que el encabezado no se recorte */
            align-items: flex-start; 
            justify-content: center;
            padding: 2rem;
        }

        /* Estilo para los inputs de n√∫mero (oculta las flechas en algunos navegadores) */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Animaci√≥n para resultados */
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Colores de clasificaci√≥n basados en la paleta Azul/Blanco/Verde */
        .bg-excelente { background-color: #38A169; } /* Verde Fuerte */
        .bg-bueno { background-color: #68D391; } /* Verde Medio */
        .bg-regular { background-color: #FFC107; } /* Amarillo */
        .bg-mejorar { background-color: #DC3545; } /* Rojo */
        
        /* Ajuste de color en la barra de progreso: de Verde a Rojo */
        .progreso-fill {
            background-image: linear-gradient(90deg, #38A169 0%, #68D391 25%, #FFC107 50%, #ff9800 75%, #dc3545 100%);
            transition: width 0.8s ease;
        }

        /* Estilo espec√≠fico para las etiquetas de las tablas en m√≥vil */
        .mobile-label {
            display: block;
            font-weight: 600;
            color: #4B5563; /* Gris oscuro para las etiquetas */
        }
        /* Oculta las etiquetas en escritorio */
        @media (min-width: 768px) {
            .mobile-label {
                display: none;
            }
        }
        
        /* Estilo para la selecci√≥n de tipolog√≠a (Checkbox como Card) */
        .tipologia-card {
            cursor: pointer;
            transition: all 0.2s;
        }
        .tipologia-card:hover {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .tipologia-checkbox:checked + .tipologia-card {
            border-color: #22577A; /* Azul corporativo cuando est√° marcado */
            background-color: #E6F0F4; /* Fondo azul muy claro para marcado */
            box-shadow: 0 0 0 3px #4A90E2; /* Anillo azul brillante */
        }
    </style>
</head>
<body class="bg-cier-light-blue">
    
    <!-- CONTENEDOR PRINCIPAL Y DE LOGO -->
    <div class="relative mx-auto max-w-5xl">
        
        <!-- LOGO - POSICIONADO ABSOLUTO -->
        <img src="Logo.png" alt="Logo CIER" class="absolute left-1/2 -translate-x-1/2 top-[-60px] w-[150px] z-20">
        
        <!-- Contenedor blanco/gris de la App -->
        <div class="container bg-white rounded-xl shadow-2xl overflow-hidden my-10">
            <!-- HEADER / BANNER - AZUL CORPORATIVO -->
            <div class="bg-cier-blue text-white p-10 text-center">
                <h1 class="text-3xl font-extrabold mb-2">üìä Calculadora de Accidentalidad para Personal Propio - CIER 2025</h1>
                <p class="text-xl font-light opacity-90">Empresas de Distribuci√≥n o Integradas (m√∫ltiples negocios D, G, T, C), esta √∫ltima (Integrada) con importante participaci√≥n de la Distribuci√≥n</p>
                <div class="mt-4 inline-block bg-white bg-opacity-20 px-4 py-1 rounded-full text-sm font-medium">Personal Propio | 42 Empresas | 17 Pa√≠ses</div>
            </div>

            <div class="p-8 md:p-12">
                
                <!-- INFORMACI√ìN / CONTEXTO -->
                <section class="mb-12 border-l-4 border-cier-blue bg-gray-50 p-6 rounded-lg shadow-inner">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cier-blue mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M14 10l-2 1m0 0l-2-1m2 1v6m-4 2a2 2 0 104 0m-4 0a2 2 0 114 0m-6 0a2 2 0 104 0m-4 0a2 2 0 114 0" />
                        </svg>
                        Contexto de la Herramienta
                    </h2>
                    <p class="text-gray-600 mb-4">Esta aplicaci√≥n est√° dise√±ada espec√≠ficamente para **empresas de Distribuci√≥n o Integradas (m√∫ltiples negocios) con importante participaci√≥n de la Distribuci√≥n ** del sector el√©ctrico. Utiliza una base de datos real de CIER para comparar la accidentalidad de su **Personal Propio** (empleados directos).</p>
                    <div class="bg-blue-50 border-l-4 border-cier-blue text-gray-800 p-4 rounded-md">
                        <h3 class="font-semibold text-cier-blue mb-2">‚úÖ Base de Comparaci√≥n (n=42):</h3>
                        <ul class="list-none space-y-1 text-sm">
                            <li>**Robustez:** 42 empresas de distribuci√≥n e integradas.</li>
                            <li>**Alcance:** Datos de 17 pa√≠ses de Am√©rica Latina.</li>
                            <li>**Metodolog√≠a:** An√°lisis con Distribuci√≥n Gamma para un *benchmarking* robusto.</li>
                        </ul>
                    </div>
                </section>

                <!-- ESTAD√çSTICAS DEL SECTOR (CORREGIDAS) -->
                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">
                        <span class="text-cier-blue">üìä</span> Estad√≠sticas del Sector (TFCPSI)
                    </h2>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <div class="p-4 bg-gray-50 rounded-lg shadow-md border border-gray-200 text-center">
                            <div class="text-sm text-gray-500 font-semibold uppercase">Empresas</div>
                            <div class="text-3xl font-extrabold text-cier-blue mt-1">42</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg shadow-md border border-gray-200 text-center">
                            <div class="text-sm text-gray-500 font-semibold uppercase">Promedio</div>
                            <div class="text-3xl font-extrabold text-cier-blue mt-1">13.64</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg shadow-md border border-gray-200 text-center">
                            <div class="text-sm text-gray-500 font-semibold uppercase">Mediana</div>
                            <div class="text-3xl font-extrabold text-success-dark mt-1">6.54</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg shadow-md border border-gray-200 text-center">
                            <div class="text-sm text-gray-500 font-semibold uppercase">M√≠nimo</div>
                            <div class="text-3xl font-extrabold text-gray-700 mt-1">0.00</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg shadow-md border border-gray-200 text-center">
                            <div class="text-sm text-gray-500 font-semibold uppercase">M√°ximo</div>
                            <div class="text-3xl font-extrabold text-red-600 mt-1">144.79</div>
                        </div>
                    </div>
                    <div class="bg-warning-light border-l-4 border-yellow-500 p-4 mt-6 text-sm text-yellow-800 rounded-md">
                        <strong class="text-yellow-900">¬øQu√© es TFCPSI?</strong> La Tasa de Frecuencia de Accidentes con P√©rdida de D√≠as es el n√∫mero de accidentados por cada mill√≥n de horas trabajadas. **Mientras m√°s bajo, mejor.**
                    </div>
                </section>

                <!-- FORMULARIO DE INGRESO DE DATOS -->
                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">
                        <span class="text-cier-blue">üìù</span> Para compararse con la regi√≥n, ingrese los Datos de su Empresa para Personal Propio (Sin incluir Accidentes in Itinere)
                    </h2>
                    
                    <!-- Entrada de Datos Pasados (√öltimos 12 Meses) -->
                    <div class="p-6 bg-gray-100 rounded-lg border border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Datos Hist√≥ricos para Personal Propio (√öltimos 12 Meses)</h3>

                        <div class="mb-6">
                            <label for="nacpdsi" class="block text-gray-700 font-medium mb-2">NACPDSI - N√∫mero de Accidentados con P√©rdida de D√≠as Sin In Itinere :</label>
                            <span class="block text-sm text-gray-500 mb-2">Cantidad de trabajadores propios accidentados (sin *in itinere*) correspondientes a los **√öltimos 12 Meses**.</span>
                            <input type="number" id="nacpdsi" placeholder="Ejemplo: 3" min="0" step="1" oninput="calcularTFCPSI()" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-cier-blue">
                        </div>

                        <div class="mb-6">
                            <label for="hht" class="block text-gray-700 font-medium mb-2">HHT - Horas Hombre Trabajadas (Personal Propio):</label>
                            <span class="block text-sm text-gray-500 mb-2">Total de horas trabajadas por su personal propio en el per√≠odo de los **√öltimos 12 Meses**.</span>
                            <input type="number" id="hht" placeholder="Ejemplo: 500000" min="1" step="1" oninput="calcularTFCPSI()" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-cier-blue">
                        </div>

                        <!-- TFCPSI Calculado en tiempo real -->
                        <div class="info-calculada mt-6 p-4 rounded-lg border-l-4 border-success-dark bg-success-light" id="info-tfcpsi" style="display: none;">
                            <h3 class="text-lg font-bold text-green-800">üìä Tu TFCPSI Calculado:</h3>
                            <p class="text-sm text-green-700">TFCPSI = (NACPDSI √ó 1,000,000) / HHT</p>
                            <p class="text-lg text-green-900 mt-2">Tu TFCPSI = <strong id="tfcpsi-calculado" class="text-xl"> - </strong></p>
                        </div>

                        <h3 class="text-xl font-semibold text-gray-700 mt-8 mb-4">Proyecci√≥n (Pr√≥ximos 12 Meses)</h3>
                        <div class="mb-6">
                            <label for="hht-futuras" class="block text-gray-700 font-medium mb-2">HHT - Horas Hombre Trabajadas Proyectadas (para el pr√≥ximo per√≠odo):</label>
                            <span class="block text-sm text-gray-500 mb-2">Total de Horas Hombre Trabajadas esperadas para un **Per√≠odo de 12 Meses Futuros**.</span>
                            <input type="number" id="hht-futuras" placeholder="Ejemplo: 550000" min="1" step="1" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-cier-blue">
                        </div>
                    </div>
                    
                    <!-- NUEVA SECCI√ìN: AN√ÅLISIS DE CAUSAS RA√çZ (CHECKBOXES PARA M√ìVIL) -->
                    <div class="p-6 bg-gray-100 rounded-lg border border-gray-200 mt-8">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                            <span class="text-accent-blue mr-2">üîé</span> An√°lisis de Causas Ra√≠z (Pareto)
                        </h3>
                        <p class="block text-sm text-gray-500 mb-4">Seleccione las **tipolog√≠as de accidentes** que m√°s le preocupan o que han afectado a su empresa. (Toque para seleccionar/deseleccionar)</p>
                        
                        <div id="tipologia-selector-container" class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-96 overflow-y-auto pr-2">
                            <!-- Opciones generadas din√°micamente o a√±adidas aqu√≠ -->
                            
                            <!-- Opci√≥n 1 -->
                            <input type="checkbox" id="tipologia-1" name="tipologia" value="Ca√≠das de personas a Nivel y/o Altura" data-percent="18.4" class="tipologia-checkbox hidden">
                            <label for="tipologia-1" class="tipologia-card p-3 border-2 border-gray-300 rounded-lg shadow-sm block text-gray-700 text-sm font-medium">
                                Ca√≠das de personas a Nivel y/o Altura <span class="text-gray-500 font-normal float-right"></span>
                            </label>
                            
                            <!-- Opci√≥n 2 -->
                            <input type="checkbox" id="tipologia-2" name="tipologia" value="Golpes por objetos" data-percent="17.7" class="tipologia-checkbox hidden">
                            <label for="tipologia-2" class="tipologia-card p-3 border-2 border-gray-300 rounded-lg shadow-sm block text-gray-700 text-sm font-medium">
                                Golpes por objetos <span class="text-gray-500 font-normal float-right"></span>
                            </label>

                            <!-- Opci√≥n 3 -->
                            <input type="checkbox" id="tipologia-3" name="tipologia" value="Esfuerzos excesivos" data-percent="16.2" class="tipologia-checkbox hidden">
                            <label for="tipologia-3" class="tipologia-card p-3 border-2 border-gray-300 rounded-lg shadow-sm block text-gray-700 text-sm font-medium">
                                Esfuerzos excesivos <span class="text-gray-500 font-normal float-right"></span>
                            </label>

                            <!-- Opci√≥n 4 -->
                            <input type="checkbox" id="tipologia-4" name="tipologia" value="Otras formas de accidentes" data-percent="12.5" class="tipologia-checkbox hidden">
                            <label for="tipologia-4" class="tipologia-card p-3 border-2 border-gray-300 rounded-lg shadow-sm block text-gray-700 text-sm font-medium">
                                Otras formas de accidentes <span class="text-gray-500 font-normal float-right"></span>
                            </label>
                            
                            <!-- Opci√≥n 5 -->
                            <input type="checkbox" id="tipologia-5" name="tipologia" value="Choques Veh√≠culo" data-percent="7.7" class="tipologia-checkbox hidden">
                            <label for="tipologia-5" class="tipologia-card p-3 border-2 border-gray-300 rounded-lg shadow-sm block text-gray-700 text-sm font-medium">
                                Choques Veh√≠culo <span class="text-gray-500 font-normal float-right"></span>
                            </label>

                            <!-- Opci√≥n 6 -->
                            <input type="checkbox" id="tipologia-6" name="tipologia" value="Malas pisadas" data-percent="6.1" class="tipologia-checkbox hidden">
                            <label for="tipologia-6" class="tipologia-card p-3 border-2 border-gray-300 rounded-lg shadow-sm block text-gray-700 text-sm font-medium">
                                Malas pisadas <span class="text-gray-500 font-normal float-right"></span>
                            </label>

                            <!-- Opci√≥n 7 -->
                            <input type="checkbox" id="tipologia-7" name="tipologia" value="Golpe por ca√≠das de objetos" data-percent="4.7" class="tipologia-checkbox hidden">
                            <label for="tipologia-7" class="tipologia-card p-3 border-2 border-gray-300 rounded-lg shadow-sm block text-gray-700 text-sm font-medium">
                                Golpe por ca√≠das de objetos <span class="text-gray-500 font-normal float-right"></span>
                            </label>
                            
                            <!-- Opci√≥n 8 -->
                            <input type="checkbox" id="tipologia-8" name="tipologia" value="Atrapamiento por un objeto o entre objetos" data-percent="4.2" class="tipologia-checkbox hidden">
                            <label for="tipologia-8" class="tipologia-card p-3 border-2 border-gray-300 rounded-lg shadow-sm block text-gray-700 text-sm font-medium">
                                Atrapamiento por un objeto o entre objetos <span class="text-gray-500 font-normal float-right"></span>
                            </label>
                            
                            <!-- Opci√≥n 9 -->
                            <input type="checkbox" id="tipologia-9" name="tipologia" value="Contacto con electricidad" data-percent="3.5" class="tipologia-checkbox hidden">
                            <label for="tipologia-9" class="tipologia-card p-3 border-2 border-gray-300 rounded-lg shadow-sm block text-gray-700 text-sm font-medium">
                                Contacto con electricidad <span class="text-gray-500 font-normal float-right"></span>
                            </label>
                            
                            <!-- Opci√≥n 10 -->
                            <input type="checkbox" id="tipologia-10" name="tipologia" value="Picadura de insectos, otros" data-percent="2.5" class="tipologia-checkbox hidden">
                            <label for="tipologia-10" class="tipologia-card p-3 border-2 border-gray-300 rounded-lg shadow-sm block text-gray-700 text-sm font-medium">
                                Picadura de insectos, otros <span class="text-gray-500 font-normal float-right"></span>
                            </label>
                            
                        </div>
                    </div>

                    
                    <div class="text-center mt-8">
                        <button onclick="analizarYPredecir()" id="btn-analizar" class="bg-cier-blue text-white px-10 py-4 text-lg font-semibold rounded-full shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition duration-300 ease-in-out hover:bg-opacity-90">
                            Analizar y Comparar
                        </button>
                    </div>
                </section>
                
                <!-- SECCI√ìN ELIMINADA (GEMINI API) -->
                <!-- <section class="mb-12 p-6 bg-white rounded-xl shadow-lg border-l-4 border-accent-blue">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <span class="text-accent-blue mr-2">ü§ñ</span> Herramientas de Inteligencia Artificial (Gemini)
                    </h2>
                    <p class="text-gray-600 mb-4">Utilice el poder de la IA para generar contenido estrat√©gico basado en su an√°lisis de accidentalidad y sus focos de riesgo seleccionados.</p>
                    
                    <div class="flex flex-col sm:flex-row gap-4 mt-4">
                        <button onclick="generarPlanEstrategicoLLM()" id="btn-gemini-plan" class="w-full bg-success-dark text-white px-6 py-3 text-lg font-semibold rounded-lg shadow-md hover:shadow-xl transition duration-300 ease-in-out hover:bg-opacity-90">
                            Generar Plan Estrat√©gico (IA) ‚ú®
                        </button>
                    </div>
                </section>
                
                <div id="gemini-results" class="mb-12 hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <span class="text-accent-blue mr-2">‚ú®</span> Plan de Acci√≥n Generado por IA
                    </h2>
                    <div id="gemini-loading" class="hidden"></div>
                    <div id="gemini-output" class="p-6 bg-white rounded-xl shadow-lg border-l-4 border-success-dark">
                    </div>
                </div> -->

                <!-- SECCI√ìN DE RESULTADOS DIN√ÅMICA -->
                <div class="resultados hidden fade-in" id="resultados">
                    <!-- Contenido din√°mico del resultado -->
                </div>
            </div>

            <!-- FOOTER -->
            <footer class="bg-gray-100 p-6 text-center text-sm text-gray-600 border-t border-gray-200">
                <p class="font-bold text-gray-800">Calculadora de Accidentalidad CIER 2025</p>
                <p>Comisi√≥n de Integraci√≥n Energ√©tica Regional</p>
                <p class="mt-2 text-xs">Metodolog√≠a: Distribuci√≥n Gamma para an√°lisis estad√≠stico robusto.</p>
                <p class="mt-2 text-xs">Coordinaci√≥n Internacional del √Årea Corporativa y Coordinador T√©cnico Internacional SST - CIER</p>
            </footer>
        </div>
    </div>

    <script>
        // ============================================
        // SETUP Y UTILIDADES
        // ============================================
        
        // Se elimina la clave de API y las funciones relacionadas con la API de Gemini
        // La funcionalidad LLM ya no est√° disponible en esta versi√≥n para publicaci√≥n est√°tica.

        
        const datosCIER = [
          6.494611421, 38.82800285, 6.796793308, 144.7876448, 1.828367487,
          1.119837131, 1.661937347, 0.485178288, 12.63178789, 1.030333004,
          2.045010685, 8.233677545, 77.60721437, 8.99261167, 0.6816614,
          5.212626284, 3.430539578, 0, 8.132196994, 11.24242682, 11.67365237,
          3.85310879, 32.32200718, 14.16493193, 17.71975823, 23.32650032,
          0, 24.09822436, 3.950807703, 37.37128026, 23.9092133, 6.592827004,
          0.74718823, 0.903252409, 0.420180602, 2.105733069, 7.499521184,
          0, 3.971058923, 7.092869826, 9.731084718, 0
        ];
        
        const datosPareto = {
            "Ca√≠das de personas a Nivel y/o Altura": { percent: 18.4, riesgo: "Alto", sugerencias: ["Refuerzo en protocolos de trabajo en altura (arneses, l√≠neas de vida).", "Inspecci√≥n rigurosa de andamios, escaleras y plataformas.", "Capacitaci√≥n espec√≠fica en rescate en altura."]},
            "Golpes por objetos": { percent: 17.7, riesgo: "Alto", sugerencias: ["Uso obligatorio y permanente de Equipo de Protecci√≥n Personal (EPP) de cabeza y manos.", "Mejora del orden y limpieza en √°reas de trabajo.", "An√°lisis de riesgo en manejo de herramientas y materiales."]},
            "Esfuerzos excesivos": { percent: 16.2, riesgo: "Alto", sugerencias: ["Entrenamiento en ergonom√≠a y t√©cnicas correctas de levantamiento de cargas.", "Implementaci√≥n de ayudas mec√°nicas para tareas repetitivas o pesadas.", "Rotaci√≥n de tareas para prevenir fatiga muscular."]},
            "Otras formas de accidentes": { percent: 12.5, riesgo: "Medio", sugerencias: ["Revisi√≥n profunda de los incidentes para identificar categor√≠as no cubiertas.", "Fomentar el reporte de casi-accidentes para capturar riesgos diversos.", "Campa√±a de concientizaci√≥n sobre el riesgo residual."]},
            "Choques Veh√≠culo": { percent: 7.7, riesgo: "Medio", sugerencias: ["Capacitaci√≥n obligatoria en conducci√≥n defensiva y manejo 4x4.", "Mantenimiento estricto de la flota y uso de tecnolog√≠as de monitoreo de velocidad.", "Reforzar el protocolo de descanso en rutas largas."]},
            "Malas pisadas": { percent: 6.1, riesgo: "Medio", sugerencias: ["Mantenimiento de zonas de paso y se√±alizaci√≥n de desniveles.", "Uso de calzado de seguridad con agarre apropiado.", "Campa√±a de concientizaci√≥n sobre atenci√≥n al camino."]},
            "Golpe por ca√≠das de objetos": { percent: 4.7, riesgo: "Bajo", sugerencias: ["Protocolos obligatorios para asegurar herramientas y materiales en altura.", "Uso de redes de seguridad o zonas de exclusi√≥n por debajo de trabajos elevados.", "Verificaci√≥n de anclajes y sistemas de izado."]},
            "Atrapamiento por un objeto o entre objetos": { percent: 4.2, riesgo: "Bajo", sugerencias: ["Implementaci√≥n del protocolo LOTO (Lockout/Tagout) para energ√≠as peligrosas.", "Distanciamiento de seguridad en maquinaria en movimiento.", "Capacitaci√≥n en riesgos mec√°nicos."]},
            "Contacto con electricidad": { percent: 3.5, riesgo: "Bajo", sugerencias: ["Refuerzo en los 5 pasos de oro de seguridad el√©ctrica.", "Auditor√≠a de EPP diel√©ctrico y herramientas aisladas.", "Campa√±a de concientizaci√≥n sobre l√≠neas vivas o desenergizadas."]},
            "Picadura de insectos, otros": { percent: 2.5, riesgo: "Bajo", sugerencias: ["Uso de repelentes y ropa adecuada para trabajos en campo.", "Inspecci√≥n previa de √°reas de trabajo boscosas/rurales.", "Protocolo claro de primeros auxilios para picaduras."]}
        };

        
        function calcularEstadisticas(datos) {
            const n = datos.length;
            const datosOrdenados = [...datos].sort((a, b) => a - b);
            const promedio = datos.reduce((a, b) => a + b, 0) / n;
            const mediana = n % 2 === 0 
                ? (datosOrdenados[n/2 - 1] + datosOrdenados[n/2]) / 2 
                : datosOrdenados[Math.floor(n/2)];
            const varianza = datos.reduce((sum, val) => sum + Math.pow(val - promedio, 2), 0) / n;
            const desviacion = Math.sqrt(varianza);
            const minimo = Math.min(...datos);
            const maximo = Math.max(...datos);
            const shapeK = Math.pow(promedio, 2) / varianza;
            const scaleTheta = varianza / promedio;
            
            return { n, promedio, mediana, desviacion, minimo, maximo, datosOrdenados, shapeK, scaleTheta };
        }
        
        const stats = calcularEstadisticas(datosCIER);
        
        function percentilGamma(p, shape, scale) {
            let z;
            if (p === 0.10) z = -1.282; else if (p === 0.25) z = -0.674; else if (p === 0.50) z = 0;
            else if (p === 0.75) z = 0.674; else if (p === 0.90) z = 1.282; else return 0;
            
            const factor = 1 - 1/(9*shape) + z * Math.sqrt(1/(9*shape));
            const valor = shape * scale * Math.pow(factor, 3);
            return Math.max(0, valor);
        }
        
        const percentilesGamma = {
            p10: percentilGamma(0.10, stats.shapeK, stats.scaleTheta),
            p25: percentilGamma(0.25, stats.shapeK, stats.scaleTheta),
            p50: percentilGamma(0.50, stats.shapeK, stats.scaleTheta),
            p75: percentilGamma(0.75, stats.shapeK, stats.scaleTheta),
            p90: percentilGamma(0.90, stats.shapeK, stats.scaleTheta)
        };
        
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }
        
        function calcularTFCPSI() {
            const nacpdsi = parseFloat(document.getElementById('nacpdsi').value);
            const hht = parseFloat(document.getElementById('hht').value);
            const infoTfcpsiDiv = document.getElementById('info-tfcpsi');
            
            if (!isNaN(nacpdsi) && !isNaN(hht) && hht > 0) {
                const tfcpsi = (nacpdsi * 1000000) / hht;
                document.getElementById('tfcpsi-calculado').textContent = tfcpsi.toFixed(2);
                infoTfcpsiDiv.style.display = 'block';
            } else {
                infoTfcpsiDiv.style.display = 'none';
            }
        }
        
        function analizarTFCPSI(tfcpsi, stats) {
            let posicion = 0;
            for (let i = 0; i < stats.datosOrdenados.length; i++) {
                if (tfcpsi <= stats.datosOrdenados[i]) {
                    posicion = i + 1;
                    break;
                }
            }
            if (posicion === 0) posicion = stats.datosOrdenados.length + 1;
            
            const percentil = (posicion / stats.n) * 100;
            const zScore = (tfcpsi - stats.promedio) / stats.desviacion;
            const diferenciaPorcentaje = ((tfcpsi - stats.promedio) / stats.promedio) * 100;
            
            let clasificacion, colorClase, interpretacion;
            
            if (percentil <= 25) { 
                clasificacion = "EXCELENTE";
                colorClase = "excelente";
                interpretacion = "Tu desempe√±o te sit√∫a entre el TOP 25% de las empresas del sector. Contin√∫a con el liderazgo.";
            } else if (percentil <= 50) {
                clasificacion = "BUENO";
                colorClase = "bueno";
                interpretacion = "Tu desempe√±o est√° en la mitad superior del sector. Tienes buen rendimiento y potencial de ascenso.";
            } else if (percentil <= 75) {
                clasificacion = "REGULAR";
                colorClase = "regular";
                interpretacion = "Tu desempe√±o est√° en la mitad inferior del sector. Requiere un plan de acci√≥n para alcanzar la Mediana.";
            } else {
                clasificacion = "NECESITA MEJORAR";
                colorClase = "mejorar";
                interpretacion = "Tu desempe√±o est√° en el cuartil de mayor accidentalidad. Requiere acciones de mejora urgentes.";
            }
            
            return { posicion, percentil, zScore, clasificacion, colorClase, interpretacion, diferenciaPorcentaje };
        }
        
        function analizarYPredecir() {
            const nacpdsi = parseFloat(document.getElementById('nacpdsi').value);
            const hht = parseFloat(document.getElementById('hht').value);
            const hhtFuturas = parseFloat(document.getElementById('hht-futuras').value);
            
            // Validaci√≥n de datos TFCPSI
            if (isNaN(nacpdsi) || isNaN(hht) || hht <= 0 || isNaN(hhtFuturas) || hhtFuturas <= 0) {
                alert('Paso 1 requerido: Por favor, ingresa NACPDSI, HHT y HHT Proyectadas v√°lidos.');
                return;
            }

            // Validaci√≥n de selecci√≥n de riesgos (aunque no afecta el TFCPSI, es necesario para el LLM)
            const tipologiaCheckboxes = document.querySelectorAll('input[name="tipologia"]:checked');
            if (tipologiaCheckboxes.length === 0) {
                 alert('Paso 2 requerido: Por favor, selecciona al menos una Tipolog√≠a de Caso para el An√°lisis Pareto.');
                return;
            }
            
            const tfcpsi = (nacpdsi * 1000000) / hht;
            const resultado = analizarTFCPSI(tfcpsi, stats);
            
            // Generar HTML de resultados
            let html = generarSeccionExplicacion();
            html += generarResultadoPrincipal(tfcpsi, resultado);
            html += generarSeccionTipologia(Array.from(tipologiaCheckboxes).map(checkbox => ({
                tipologia: checkbox.value,
                percent: parseFloat(checkbox.dataset.percent)
            })));
            html += generarSeccionPosicion(resultado);
            html += generarSeccionComparacion(tfcpsi, resultado);
            html += generarSeccionPrediccion(tfcpsi, hhtFuturas);
            html += generarSeccionPercentiles();
            html += generarSeccionRecomendaciones(resultado, hhtFuturas, tfcpsi);
            html += generarSeccionSensibilidad(tfcpsi, hhtFuturas);
            
            // Mostrar resultados
            const resultadosDiv = document.getElementById('resultados');
            resultadosDiv.innerHTML = html;
            resultadosDiv.classList.remove('hidden');
            resultadosDiv.classList.add('fade-in');
            resultadosDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // ELIMINACI√ìN DE LA FUNCIONALIDAD LLM PARA PUBLICACI√ìN EST√ÅTICA
            // Las secciones LLM y el bot√≥n fueron comentados o eliminados del HTML
        }

        // ============================================
        // GENERAR SECCIONES HTML
        // ============================================

        function generarSeccionExplicacion() {
            const filas = [
                { class: 'bg-success-light border-success-dark', clasificacion: 'EXCELENTE', rango: 'Menor o igual al 25%', significado: 'Su TFCPSI es mejor que el 75% de las empresas del sector (L√≠der).' },
                { class: 'bg-gray-50 border-success-dark', clasificacion: 'BUENO', rango: 'Entre 25% y 50%', significado: 'Su desempe√±o est√° en la mitad superior. Potencial de ascenso.' },
                { class: 'bg-warning-light border-yellow-500', clasificacion: 'REGULAR', rango: 'Entre 50% y 75%', significado: 'Se encuentra en la mitad inferior. La Mediana es su primera meta.' },
                { class: 'bg-danger-light border-red-500', clasificacion: 'NECESITA MEJORAR', rango: 'Mayor al 75%', significado: 'Est√° en el cuartil de mayor riesgo. Acci√≥n urgente.' }
            ];

            const contenidoFilas = filas.map(fila => `
                <div class="p-4 rounded-lg border-l-4 ${fila.class} grid grid-cols-1 md:grid-cols-3 gap-1 md:gap-3 items-center shadow-sm">
                    <span class="text-sm font-bold md:col-span-1 text-gray-800">${fila.clasificacion}</span>
                    <span class="text-sm text-gray-700 md:col-span-1"><span class="mobile-label">Percentil:</span> ${fila.rango}</span>
                    <span class="text-sm text-gray-700 md:col-span-1"><span class="mobile-label">Significado:</span> ${fila.significado}</span>
                </div>
            `).join('');


            return `
                <!-- EXPLICACI√ìN DID√ÅCTICA DEL CRITERIO DE CLASIFICACI√ìN (Percentiles) -->
                <section class="mb-12 p-6 bg-white rounded-xl shadow-lg border-l-4 border-success-dark">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                        <span class="text-success-dark mr-2">‚≠ê</span> Criterio de Clasificaci√≥n: El Poder del Percentil
                    </h2>
                    <p class="text-gray-600 mb-6">La accidentalidad es asim√©trica, por eso no usamos el promedio simple (que puede ser enga√±oso). Su clasificaci√≥n se basa en su **Percentil**, que indica qu√© tan bien se desempe√±a su empresa comparada con las 42 empresas del sector.</p>

                    <!-- CUADRO EXPLICATIVO DID√ÅCTICO RESPONSIVO -->
                    <div class="space-y-3">
                        <!-- Encabezado de la "Tabla" (Solo visible en escritorio) -->
                        <div class="hidden md:grid md:grid-cols-3 gap-3 px-4 py-2 bg-cier-blue text-white rounded-lg text-xs font-medium uppercase">
                            <span>Clasificaci√≥n</span>
                            <span>Rango de Percentil</span>
                            <span>Significado Pr√°ctico</span>
                        </div>
                        
                        ${contenidoFilas}
                    </div>
                </section>
            `;
        }


        function generarResultadoPrincipal(tfcpsi, resultado) {
            return `
                <div class="p-8 text-white text-center rounded-xl mb-8 shadow-xl bg-cier-blue">
                    <h2 class="text-3xl font-semibold mb-2">Tu Resultado de Accidentalidad</h2>
                    <div class="text-sm opacity-80 mb-6">Distribuci√≥n & Integradas | Personal Propio | CIER 2025</div>
                    <div class="text-xl font-medium opacity-90">Tu Tasa de Frecuencia (TFCPSI)</div>
                    <div class="text-6xl font-extrabold my-4 tracking-tight tfcpsi-valor">${tfcpsi.toFixed(2)}</div>
                    <div class="inline-block px-8 py-2 rounded-full text-xl font-bold uppercase shadow-lg text-white bg-${resultado.colorClase} clasificacion">
                        ${resultado.clasificacion}
                    </div>
                    <div class="text-lg mt-4 p-3 bg-white bg-opacity-20 rounded-lg">${resultado.interpretacion}</div>
                </div>
            `;
        }
        
        function generarSeccionTipologia(seleccionTipologia) {
            const totalPercent = seleccionTipologia.reduce((sum, item) => sum + item.percent, 0);

            // Generar sugerencias √∫nicas basadas en la selecci√≥n
            let sugerenciasUnicas = new Set();
            seleccionTipologia.forEach(item => {
                const data = datosPareto[item.tipologia];
                if (data && data.sugerencias) {
                    data.sugerencias.forEach(sug => sugerenciasUnicas.add(sug));
                }
            });

            // Tomar las primeras 3 sugerencias √∫nicas
            const sugerenciasFinales = Array.from(sugerenciasUnicas).slice(0, 3);
            
            let tipologiaHtml = seleccionTipologia.map(item => `
                <div class="grid grid-cols-2 py-2 px-4 border-b border-gray-100 last:border-b-0">
                    <span class="text-gray-700 font-medium">${item.tipologia}</span>
                    <span class="font-bold text-accent-blue text-right">${item.percent.toFixed(1)}%</span>
                </div>
            `).join('');

            let sugerenciasHtml = sugerenciasFinales.map(sug => `
                <li class="p-3 border-b last:border-b-0 text-gray-700 relative pl-6">
                    <span class="absolute left-0 top-3 text-lg text-success-dark">‚úî</span> ${sug}
                </li>
            `).join('');

            // Determinaci√≥n simple de coincidencia did√°ctica
            let coincidenciaTexto;
            if (totalPercent > 50) {
                coincidenciaTexto = "Alta coincidencia. Las √°reas que le preocupan son los principales focos de riesgo del sector.";
            } else if (totalPercent > 25) {
                coincidenciaTexto = "Coincidencia moderada. Sus focos de riesgo se alinean con una parte significativa de los accidentes del sector.";
            } else {
                coincidenciaTexto = "Coincidencia baja. Si bien es importante, el sector tiene mayores desaf√≠os en otras √°reas.";
            }


            return `
                <section class="mb-12 p-6 bg-white rounded-xl shadow-lg border-l-4 border-accent-blue">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <span class="text-accent-blue mr-2">üéØ</span> An√°lisis Pareto y Sugerencias Proactivas
                    </h2>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- Panel de Pareto -->
                        <div class="p-5 bg-gray-50 rounded-lg border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Tu Foco vs. Distribuci√≥n CIER</h3>
                            <div class="text-sm text-gray-600 mb-4">
                                Los porcentajes son la media de ocurrencia por tipolog√≠a seg√∫n la **muestra de empresas CIER**.
                                <p class="font-bold mt-2 text-cier-blue">${coincidenciaTexto}</p>
                                <p class="font-extrabold mt-2 text-xl text-success-dark">Total Riesgo Seleccionado: ${totalPercent.toFixed(1)}%</p>
                            </div>
                            <div class="bg-white rounded-lg shadow-inner divide-y divide-gray-100">
                                <!-- Encabezados de la tabla de Pareto -->
                                <div class="grid grid-cols-2 font-bold bg-gray-100 py-2 px-4 rounded-t-lg border-b border-gray-200">
                                    <span>Tu Foco</span>
                                    <span class="text-right">Distribuci√≥n CIER (%)</span>
                                </div>
                                ${tipologiaHtml}
                            </div>
                        </div>

                        <!-- Panel de Sugerencias -->
                        <div class="p-5 bg-cier-light-blue rounded-lg border border-cier-blue">
                            <h3 class="text-xl font-bold text-cier-blue mb-4">3 Sugerencias Clave para Mejorar (Ejemplos)</h3>
                            <p class="text-sm text-gray-700 mb-4">Basado en la severidad de sus prioridades y las pr√°cticas del sector:</p>
                            <ul class="list-none space-y-2 bg-white p-3 rounded-lg shadow-sm">
                                ${sugerenciasHtml}
                            </ul>
                        </div>
                    </div>
                </section>
            `;
        }

        function generarSeccionPosicion(resultado) {
            return `
                <section class="mb-12 p-6 bg-white rounded-xl shadow-lg border-l-4 border-cier-blue">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <span class="text-cier-blue mr-2">üìç</span> Tu Posici√≥n en el Sector
                    </h2>
                    
                    <div class="bg-warning-light border-l-4 border-yellow-500 p-3 mb-6 text-sm text-yellow-800 rounded-md">
                        <strong class="text-yellow-900">Gu√≠a de Percentil:</strong> Un percentil m√°s bajo significa mejor desempe√±o. El ${resultado.percentil.toFixed(1)}% indica que el ${resultado.percentil.toFixed(1)}% de las empresas tienen una tasa igual o menor a la tuya.
                    </div>
                    
                    <div class="h-10 bg-gray-200 rounded-full overflow-hidden my-4 shadow-inner">
                        <div class="progreso-fill h-full flex items-center justify-center text-white text-sm font-bold" style="width: ${resultado.percentil}%">
                            Percentil ${resultado.percentil.toFixed(1)}%
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-3 gap-6 mt-6">
                        <div class="p-5 border border-gray-200 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-cier-blue mb-2">Posici√≥n Actual</h3>
                            <div class="text-3xl font-extrabold text-gray-800">${resultado.posicion} de ${stats.n}</div>
                            <p class="text-sm text-gray-500 mt-2">${resultado.posicion <= 10 ? '‚úì Entre las 10 mejores del sector' : resultado.posicion <= 21 ? 'En la mitad superior del sector' : resultado.posicion <= 31 ? 'En la mitad inferior del sector' : 'En el cuartil con mayor accidentalidad'}</p>
                        </div>
                        
                        <div class="p-5 border border-gray-200 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-cier-blue mb-2">Tu Percentil</h3>
                            <div class="text-3xl font-extrabold text-gray-800">${resultado.percentil.toFixed(1)}%</div>
                            <p class="text-sm text-gray-500 mt-2">${resultado.percentil <= 50 ? 'Est√°s mejor que la mitad del sector.' : 'Tienes oportunidades de mejora en el cuartil inferior.'}</p>
                        </div>

                        <div class="p-5 border border-gray-200 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-cier-blue mb-2">Z-Score</h3>
                            <div class="text-3xl font-extrabold text-gray-800">${resultado.zScore.toFixed(2)} œÉ</div>
                            <p class="text-sm text-gray-500 mt-2">Mide qu√© tan lejos est√°s del promedio del sector en desviaciones est√°ndar.</p>
                        </div>
                    </div>
                </section>
            `;
        }
        
        function generarSeccionComparacion(tfcpsi, resultado) {
            const difPromedio = tfcpsi - stats.promedio;
            const porcDifPromedio = resultado.diferenciaPorcentaje;
            const difMediana = tfcpsi - stats.mediana;
            
            return `
                <section class="mb-12 p-6 bg-white rounded-xl shadow-lg border-l-4 border-cier-blue">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <span class="text-cier-blue mr-2">üìà</span> Comparaci√≥n de TFCPSI
                    </h2>
                    
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="p-5 border-l-4 ${difPromedio < 0 ? 'border-success-dark bg-success-light' : 'border-red-500 bg-danger-light'} rounded-r-lg shadow-md">
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">vs Promedio Sector</h3>
                            <div class="text-2xl font-bold ${difPromedio < 0 ? 'text-success-dark' : 'text-red-700'}">${difPromedio < 0 ? '‚úì Mejor por' : '‚úó Peor por'} ${Math.abs(difPromedio).toFixed(2)} pts</div>
                            <p class="text-sm text-gray-600 mt-2">Promedio Sector: **${stats.promedio.toFixed(2)}**</p>
                            <p class="text-sm font-semibold mt-1">${difPromedio < 0 ? `Est√°s **${Math.abs(porcDifPromedio).toFixed(1)}% MEJOR** que el promedio.` : `Est√°s **${porcDifPromedio.toFixed(1)}% por encima** del promedio.`}</p>
                        </div>
                        
                        <div class="p-5 border-l-4 ${difMediana < 0 ? 'border-success-dark bg-success-light' : 'border-red-500 bg-danger-light'} rounded-r-lg shadow-md">
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">vs Mediana Sector</h3>
                            <div class="text-2xl font-bold ${difMediana < 0 ? 'text-success-dark' : 'text-red-700'}">${difMediana < 0 ? '‚úì Superior' : '‚úó Inferior'}</div>
                            <p class="text-sm text-gray-600 mt-2">Mediana Sector: **${stats.mediana.toFixed(2)}**</p>
                            <p class="text-sm font-semibold mt-1">${difMediana < 0 ? 'Est√°s en la mitad **SUPERIOR**.' : 'Est√°s en la mitad **INFERIOR**.'}</p>
                        </div>
                        
                        <div class="p-5 border-l-4 ${tfcpsi <= percentilesGamma.p25 ? 'border-success-dark bg-success-light' : 'border-yellow-500 bg-warning-light'} rounded-r-lg shadow-md">
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">vs Top 25%</h3>
                            <div class="text-2xl font-bold ${tfcpsi <= percentilesGamma.p25 ? 'text-success-dark' : 'text-yellow-800'}">‚â§ ${percentilesGamma.p25.toFixed(2)}</div>
                            <p class="text-sm text-gray-600 mt-2">Meta de excelencia para el cuartil superior.</p>
                            <p class="text-sm font-semibold mt-1">${tfcpsi <= percentilesGamma.p25 ? '¬°Felicitaciones! Perteneces a los l√≠deres.' : `Necesitas reducir ${(tfcpsi - percentilesGamma.p25).toFixed(2)} puntos.`}</p>
                        </div>
                    </div>
                </section>
            `;
        }
        
        function generarSeccionPrediccion(tfcpsi, hhtFuturas) {
            const accidentesActual = (tfcpsi * hhtFuturas) / 1000000;
            const accidentesPromedio = (stats.promedio * hhtFuturas) / 1000000;
            const accidentesMediana = (stats.mediana * hhtFuturas) / 1000000;
            const accidentesP25 = (percentilesGamma.p25 * hhtFuturas) / 1000000;
            
            const tfcpsiOptimista = Math.max(0, stats.promedio - (1.5 * stats.desviacion));
            const accidentesOptimista = (tfcpsiOptimista * hhtFuturas) / 1000000;
            
            const difPromedio = accidentesActual - accidentesPromedio;
            const difMediana = accidentesActual - accidentesMediana;
            const difP25 = accidentesActual - accidentesP25;
            
            const hhtProyectadasFormateadas = formatNumber(hhtFuturas); // Usa el valor nominal y lo formatea

            const escenarioBox = (title, tfcpsiRef, accidentes, diferencia, esOptimista = false) => {
                const difClase = diferencia < 0 ? 'text-red-600 bg-danger-light' : 'text-success-dark bg-success-light';
                const difTexto = diferencia < 0 
                    ? `Tendr√≠as ${Math.abs(diferencia).toFixed(2)} accidentes M√ÅS`
                    : `Podr√≠as EVITAR ${Math.abs(diferencia).toFixed(2)} accidentes`;
                
                return `
                    <div class="p-5 bg-white rounded-lg shadow-md border-l-4 border-gray-300 hover:border-cier-blue transition duration-300">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2 ${esOptimista ? 'text-accent-blue' : ''}">${title}</h3>
                        <p class="text-sm text-gray-500">TFCPSI: **${tfcpsiRef.toFixed(2)}**</p>
                        <div class="text-4xl font-extrabold text-cier-blue my-2">${accidentes.toFixed(2)}</div>
                        <div class="mt-2 p-2 rounded-md font-medium text-sm ${difClase}">
                            ${esOptimista ? `‚Üí Objetivo: EVITAR ${(accidentesActual - accidentes).toFixed(2)} accidentes` : (title.includes('Manteniendo') ? 'Tu proyecci√≥n actual' : `‚Üí ${difTexto}`)}
                        </div>
                    </div>
                `;
            };
            
            return `
                <section class="mb-12 p-6 bg-white rounded-xl shadow-lg border-l-4 border-cier-blue">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <span class="text-cier-blue mr-2">üîÆ</span> Proyecci√≥n de Accidentes (12 Meses Futuros)
                    </h2>
                    <p class="text-gray-600 mb-6">Proyectado sobre **${hhtProyectadasFormateadas}** Horas Hombre Trabajadas futuras.</p>
                    
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${escenarioBox("1Ô∏è‚É£ Manteniendo tu TFCPSI actual", tfcpsi, accidentesActual, 0)}
                        ${escenarioBox("2Ô∏è‚É£ Si alcanzas el PROMEDIO del sector", stats.promedio, accidentesPromedio, difPromedio)}
                        ${escenarioBox("3Ô∏è‚É£ Si alcanzas la MEDIANA del sector", stats.mediana, accidentesMediana, difMediana)}
                        ${escenarioBox("4Ô∏è‚É£ Si entras al TOP 25%", percentilesGamma.p25, accidentesP25, difP25)}
                        ${escenarioBox("5Ô∏è‚É£ Escenario OPTIMISTA (Clase Mundial)", tfcpsiOptimista, accidentesOptimista, accidentesActual - accidentesOptimista, true)}
                    </div>
                </section>
            `;
        }
        
        function generarSeccionPercentiles() {
            const percentilBox = (label, value, explanation, isTop) => `
                <div class="p-5 bg-white rounded-lg shadow-md border-t-4 ${isTop ? 'border-success-dark' : 'border-gray-300'} text-center transition hover:shadow-xl">
                    <div class="text-sm text-gray-500 font-semibold uppercase">${label}</div>
                    <div class="text-3xl font-extrabold text-cier-blue mt-1">${value}</div>
                    <div class="text-xs text-gray-500 mt-2">${explanation}</div>
                </div>
            `;
            
            return `
                <section class="mb-12 p-6 bg-white rounded-xl shadow-lg border-l-4 border-cier-blue">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <span class="text-cier-blue mr-2">üéØ</span> Percentiles de Referencia (Gamma)
                    </h2>
                    <p class="text-gray-600 mb-6">Valores de TFCPSI suavizados por Distribuci√≥n Gamma, ideales para establecer metas.</p>
                    
                    <div class="grid md:grid-cols-5 gap-4">
                        ${percentilBox("Top 10%", `‚â§ ${percentilesGamma.p10.toFixed(2)}`, "Mejores tasas de frecuencia.", true)}
                        ${percentilBox("Top 25%", `‚â§ ${percentilesGamma.p25.toFixed(2)}`, "Meta para entrar al cuartil superior.", true)}
                        ${percentilBox("Mediana (50%)", `‚â§ ${percentilesGamma.p50.toFixed(2)}`, "El 50% de las empresas est√° por debajo.", false)}
                        ${percentilBox("Percentil 75", `‚â§ ${percentilesGamma.p75.toFixed(2)}`, "El 75% del sector est√° por debajo.", false)}
                        ${percentilBox("Percentil 90", `‚â§ ${percentilesGamma.p90.toFixed(2)}`, "Solo el 10% del sector est√° por encima.", false)}
                    </div>
                </section>
            `;
        }

        function generarSeccionRecomendaciones(resultado, hhtFuturas, tfcpsi) {
            const tfcpsiP25 = percentilesGamma.p25;
            const tfcpsiP50 = percentilesGamma.p50;
            const tfcpsiP75 = percentilesGamma.p75;
            
            const reduccionP25 = tfcpsi > tfcpsiP25 ? ((tfcpsi - tfcpsiP25) * hhtFuturas) / 1000000 : 0;
            const reduccionP50 = tfcpsi > tfcpsiP50 ? ((tfcpsi - tfcpsiP50) * hhtFuturas) / 1000000 : 0;
            const reduccionP75 = tfcpsi > tfcpsiP75 ? ((tfcpsi - tfcpsiP75) * hhtFuturas) / 1000000 : 0;
            
            let title, icon, bgColor, textColor, borderColor, recomendacionesList;

            if (resultado.percentil <= 25) {
                title = "EXCELENTE DESEMPE√ëO - Mant√©n el liderazgo";
                icon = "‚ú®";
                bgColor = 'bg-success-light';
                textColor = 'text-green-800';
                borderColor = 'border-success-dark';
                recomendacionesList = `
                    <li>**Documenta:** Sistematiza tus mejores pr√°cticas de seguridad para replicarlas y compartirlas.</li>
                    <li>**Meta:** Mantenerte en el TOP 25% (‚â§ ${tfcpsiP25.toFixed(2)}) y buscar el **cero accidentes fatales**.</li>
                    <li>**Innovaci√≥n:** Invierte en ergonom√≠a y tecnolog√≠a predictiva (IoT, AI) para la mejora continua.</li>
                `;
            } else if (resultado.percentil <= 50) {
                title = "BUEN DESEMPE√ëO - Camino al top 25%";
                icon = "üëç";
                bgColor = 'bg-success-light';
                textColor = 'text-green-800';
                borderColor = 'border-success-dark';
                recomendacionesList = `
                    <li>**Meta realista:** Reducir TFCPSI a **${tfcpsiP25.toFixed(2)}** para entrar al TOP 25%.</li>
                    <li>**Impacto:** Esto significa evitar aproximadamente **${reduccionP25.toFixed(1)} accidentes** en los pr√≥ximos 12 meses.</li>
                    <li>**Foco:** Refuerza capacitaci√≥n en los puestos de mayor riesgo (trabajo en altura, conducci√≥n).</li>
                `;
            } else if (resultado.percentil <= 75) {
                title = "DESEMPE√ëO REGULAR - Plan de mejora necesario";
                icon = "‚ö†Ô∏è";
                bgColor = 'bg-warning-light';
                textColor = 'text-yellow-800';
                borderColor = 'border-yellow-500';
                recomendacionesList = `
                    <li>**Prioridad:** Implementar un plan estructurado de mejora con m√©tricas claras.</li>
                    <li>**Meta a corto plazo:** Alcanzar la mediana del sector (**${tfcpsiP50.toFixed(2)}**), evitando **${reduccionP50.toFixed(1)} accidentes**.</li>
                    <li>**Revisi√≥n:** Auditor√≠a de cumplimiento de procedimientos y efectividad de capacitaciones.</li>
                `;
            } else {
                title = "REQUIERE ATENCI√ìN URGENTE - Acci√≥n inmediata";
                icon = "üö®";
                bgColor = 'bg-danger-light';
                textColor = 'text-red-800';
                borderColor = 'border-red-500';
                recomendacionesList = `
                    <li>**Liderazgo:** Implementar un programa integral de seguridad con **apoyo gerencial inmediato**.</li>
                    <li>**Meta inmediata:** Reducir a percentil 75 (**${tfcpsiP75.toFixed(2)}**), evitando **${reduccionP75.toFixed(1)} accidentes**.</li>
                    <li>**Asesor√≠a:** Considerar una auditor√≠a externa completa y asesor√≠a especializada en S&SO.</li>
                `;
            }

            return `
                <section class="mb-12 p-6 bg-white rounded-xl shadow-lg border-l-4 border-cier-blue">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <span class="text-cier-blue mr-2">üí°</span> Recomendaciones Personalizadas
                    </h2>
                    <div class="p-6 rounded-xl shadow-inner ${bgColor} ${borderColor} border-l-4">
                        <h3 class="text-xl font-bold ${textColor} mb-4">${icon} ${title}</h3>
                        <ul class="list-none space-y-3 ${textColor}">
                            ${recomendacionesList}
                        </ul>
                    </div>
                </section>
            `;
        }

        function generarSeccionSensibilidad(tfcpsi, hhtFuturas) {
            const accidentesActual = (tfcpsi * hhtFuturas) / 1000000;
            const mejoras = [
                { porcentaje: 10, factor: 0.90 },
                { porcentaje: 20, factor: 0.80 },
                { porcentaje: 30, factor: 0.70 },
                { porcentaje: 50, factor: 0.50 }
            ];
            
            let html = `
                <section class="mb-12 p-6 bg-white rounded-xl shadow-lg border-l-4 border-cier-blue">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <span class="text-cier-blue mr-2">‚ö°</span> An√°lisis de Sensibilidad (ROI de la Seguridad)
                    </h2>
                    
                    <p class="text-gray-600 mb-6">Proyecciones de accidentes evitados en el pr√≥ximo per√≠odo si logra reducir su TFCPSI.</p>
                    
                    <div class="space-y-4">
            `;
            
            mejoras.forEach(mejora => {
                const tfcpsiMejorado = tfcpsi * mejora.factor;
                const accidentesMejorados = (tfcpsiMejorado * hhtFuturas) / 1000000;
                const accidentesEvitados = accidentesActual - accidentesMejorados;
                
                html += `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition duration-200 flex-wrap gap-2">
                        <div class="flex flex-col md:flex-row md:items-center">
                            <span class="font-bold text-lg text-cier-blue">Meta: Reducci√≥n del ${mejora.porcentaje}%</span>
                            <span class="text-sm text-gray-500 md:ml-3">(Nuevo TFCPSI = ${tfcpsiMejorado.toFixed(2)})</span>
                        </div>
                        <div class="font-extrabold text-xl text-success-dark">
                            EVITAR√çA ${accidentesEvitados.toFixed(2)} ACCIDENTES
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    
                    <div class="bg-blue-50 border-l-4 border-accent-blue p-4 mt-6 text-sm text-gray-800 rounded-md">
                        <strong class="text-accent-blue">Valor Econ√≥mico:</strong> Cada accidente evitado representa ahorros significativos en costos m√©dicos, indemnizaciones y p√©rdidas de productividad, justificando la inversi√≥n en seguridad.
                    </div>
                </section>
            `;
            
            return html;
        }
    </script>
</body>
</html>





