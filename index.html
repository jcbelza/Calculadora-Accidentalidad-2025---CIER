<!--
Calculadora de Accidentalidad CIER 2025
Versi√≥n para publicaci√≥n en entornos web est√°ticos (GitHub Pages).
SE ELIMIN√ì LA FUNCIONALIDAD DE LA API DE GEMINI para evitar errores de conexi√≥n/API Key.
Funcionalidades incluidas:
1. Dise√±o profesional (Azul, Blanco, Verde).
2. L√≥gica de clasificaci√≥n TFCPSI basada en percentiles (cuartiles).
3. An√°lisis de Tipolog√≠a de Casos (Pareto) con checkboxes para selecci√≥n m√≥vil.
4. Cuadro de criterios de clasificaci√≥n optimizado para m√≥vil.
-->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora CIER 2025 - Distribuci√≥n & Integradas</title>
    <!-- Carga de Tailwind CSS CDN y configuraci√≥n de colores -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Paleta Sobria: Azul y Blanco como base, Verde como acento
                        'cier-blue': '#22577A', // Azul corporativo profundo
                        'cier-light-blue': '#E6F0F4', // Azul muy claro para fondo de acento
                        'success-dark': '#38A169', // Verde oscuro para √©xito
                        'success-light': '#D4EDDA', // Fondo verde claro
                        'warning-light': '#FFF3CD', // Fondo amarillo claro para advertencias
                        'danger-light': '#F8D7DA', // Fondo rojo claro para necesidad de mejora
                        'accent-blue': '#4A90E2', // Azul intermedio para acentos
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Estilos base del cuerpo */
        body {
            font-family: 'Inter', sans-serif;
            /* Fondo base azul claro */
            background-color: #C8E6F0; 
            min-height: 100vh;
            display: flex;
            /* Alinea al inicio para que el encabezado no se recorte */
            align-items: flex-start; 
            justify-content: center;
            padding: 2rem;
        }

        /* Estilo para los inputs de n√∫mero (oculta las flechas en algunos navegadores) */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Animaci√≥n para resultados */
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Colores de clasificaci√≥n basados en la paleta Azul/Blanco/Verde */
        .bg-excelente { background-color: #38A169; } /* Verde Fuerte */
        .bg-bueno { background-color: #68D391; } /* Verde Medio */
        .bg-regular { background-color: #FFC107; } /* Amarillo */
        .bg-mejorar { background-color: #DC3545; } /* Rojo */
        
        /* Ajuste de color en la barra de progreso: de Verde a Rojo */
        .progreso-fill {
            background-image: linear-gradient(90deg, #38A169 0%, #68D391 25%, #FFC107 50%, #ff9800 75%, #dc3545 100%);
            transition: width 0.8s ease;
        }

        /* Estilo espec√≠fico para las etiquetas de las tablas en m√≥vil */
        .mobile-label {
            display: block;
            font-weight: 600;
            color: #4B5563; /* Gris oscuro para las etiquetas */
        }
        /* Oculta las etiquetas en escritorio */
        @media (min-width: 768px) {
            .mobile-label {
                display: none;
            }
        }
        
        /* Estilo para la selecci√≥n de tipolog√≠a (Checkbox como Card) */
        .tipologia-card {
            cursor: pointer;
            transition: all 0.2s;
        }
        .tipologia-card:hover {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .tipologia-checkbox:checked + .tipologia-card {
            border-color: #22577A; /* Azul corporativo cuando est√° marcado */
            background-color: #E6F0F4; /* Fondo azul muy claro para marcado */
            box-shadow: 0 0 0 3px #4A90E2; /* Anillo azul brillante */
        }
    </style>
</head>
<body class="bg-cier-light-blue">
    
    <!-- CONTENEDOR PRINCIPAL Y DE LOGO -->
    <div class="relative mx-auto max-w-5xl">
        
        <!-- LOGO - POSICIONADO ABSOLUTO -->
        <img src="Logo.png" alt="Logo CIER" class="absolute left-1/2 -translate-x-1/2 top-[-60px] w-[150px] z-20">
        
        <!-- Contenedor blanco/gris de la App -->
        <div class="container bg-white rounded-xl shadow-2xl overflow-hidden my-10">
            <!-- HEADER / BANNER - AZUL CORPORATIVO -->
            <div class="bg-cier-blue text-white p-10 text-center">
                <h1 class="text-3xl font-extrabold mb-2">üìä Calculadora de Accidentalidad para Personal Propio para Empresas de Distribuci√≥n o Integradas con Negocio de Distribuci√≥n - Datos de CIER 2025</h1>
                <h1 class="text-3xl font-extrabold mb-2"> Planificador de Metas y Proyecci√≥n de accidentes</h1>
                <p class="text-xl font-light opacity-90">Empresas de Distribuci√≥n & Integradas con importante participaci√≥n de la Distribuci√≥n</p>
                <div class="mt-4 inline-block bg-white bg-opacity-20 px-4 py-1 rounded-full text-sm font-medium">Personal Propio | 42 Empresas | 17 Pa√≠ses</div>
            </div>

            <div class="p-8 md:p-12">
                
                <!-- INFORMACI√ìN / CONTEXTO -->
                <section class="mb-12 border-l-4 border-cier-blue bg-gray-50 p-6 rounded-lg shadow-inner">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cier-blue mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M14 10l-2 1m0 0l-2-1m2 1v6m-4 2a2 2 0 104 0m-4 0a2 2 0 114 0m-6 0a2 2 0 104 0m-4 0a2 2 0 114 0" />
                        </svg>
                        Contexto de la Herramienta
                    </h2>
                    <p class="text-gray-600 mb-4">Esta aplicaci√≥n est√° dise√±ada espec√≠ficamente para **empresas de Distribuci√≥n o Integradas (m√∫ltiples negocios) con importante participaci√≥n de la Distribuci√≥n ** del sector el√©ctrico. Utiliza una base de datos real de CIER para comparar la accidentalidad de su **Personal Propio** (empleados directos).</p>
                    <div class="bg-blue-50 border-l-4 border-cier-blue text-gray-800 p-4 rounded-md">
                        <h3 class="font-semibold text-cier-blue mb-2">‚úÖ Base de Comparaci√≥n (n=42):</h3>
                        <ul class="list-none space-y-1 text-sm">
                            <li>**Robustez:** 42 empresas de distribuci√≥n e integradas.</li>
                            <li>**Alcance:** Datos de 17 pa√≠ses de Am√©rica Latina.</li>
                            <li>**Metodolog√≠a:** Distribuci√≥n Log-normal validada estad√≠sticamente (p-valor KS = 0.98).</li>
                        </ul>
                    </div>
                </section>

                <!-- ESTAD√çSTICAS DEL SECTOR (CORREGIDAS) -->
                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">
                        <span class="text-cier-blue">üìä</span> Estad√≠sticas del Sector (TFCPSI)
                    </h2>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <div class="p-4 bg-gray-50 rounded-lg shadow-md border border-gray-200 text-center">
                            <div class="text-sm text-gray-500 font-semibold uppercase">Empresas</div>
                            <div class="text-3xl font-extrabold text-cier-blue mt-1">42</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg shadow-md border border-gray-200 text-center">
                            <div class="text-sm text-gray-500 font-semibold uppercase">Promedio</div>
                            <div class="text-3xl font-extrabold text-cier-blue mt-1">12.43</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg shadow-md border border-gray-200 text-center">
                            <div class="text-sm text-gray-500 font-semibold uppercase">Mediana</div>
                            <div class="text-3xl font-extrabold text-success-dark mt-1">6.07</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg shadow-md border border-gray-200 text-center">
                            <div class="text-sm text-gray-500 font-semibold uppercase">M√≠nimo</div>
                            <div class="text-3xl font-extrabold text-gray-700 mt-1">0.00</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg shadow-md border border-gray-200 text-center">
                            <div class="text-sm text-gray-500 font-semibold uppercase">M√°ximo</div>
                            <div class="text-3xl font-extrabold text-red-600 mt-1">144.79</div>
                        </div>
                    </div>
                    <div class="bg-warning-light border-l-4 border-yellow-500 p-4 mt-6 text-sm text-yellow-800 rounded-md">
                        <strong class="text-yellow-900">¬øQu√© es TFCPSI?</strong> La Tasa de Frecuencia de Accidentes con P√©rdida de D√≠as es el n√∫mero de accidentados por cada mill√≥n de horas trabajadas. **Mientras m√°s bajo, mejor.**
                    </div>
                </section>

                <!-- FORMULARIO DE INGRESO DE DATOS -->
                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">
                        <span class="text-cier-blue">üìù</span> Si te quieres comparar con el sector de la regi√≥n, ingrese los Datos de su Empresa para Personal Propio
                    </h2>
                    
                    <!-- Entrada de Datos Pasados (√öltimos 12 Meses) -->
                    <div class="p-6 bg-gray-100 rounded-lg border border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Datos Hist√≥ricos Personal Propio (√öltimos 12 Meses Pasados)</h3>

                        <div class="mb-6">
                            <label for="nacpdsi" class="block text-gray-700 font-medium mb-2">NACPDSI - N√∫mero de Accidentados con P√©rdida de D√≠as Sin In Itinere para Personal Propio:</label>
                            <span class="block text-sm text-gray-500 mb-2">Cantidad de trabajadores accidentados (sin *in itinere*) correspondientes a los **√öltimos 12 Meses Pasados**.</span>
                            <input type="number" id="nacpdsi" placeholder="Ejemplo: 3" min="0" step="1" oninput="calcularTFCPSI()" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-cier-blue">
                        </div>

                        <div class="mb-6">
                            <label for="hht" class="block text-gray-700 font-medium mb-2">HHT - Horas Hombre Trabajadas (Personal Propio):</label>
                            <span class="block text-sm text-gray-500 mb-2">Total de horas trabajadas por su personal propio en el per√≠odo de los **√öltimos 12 Meses**.</span>
                            <input type="number" id="hht" placeholder="Ejemplo: 500000" min="1" step="1" oninput="calcularTFCPSI()" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-cier-blue">
                        </div>

                        <!-- TFCPSI Calculado en tiempo real -->
                        <div class="info-calculada mt-6 p-4 rounded-lg border-l-4 border-success-dark bg-success-light" id="info-tfcpsi" style="display: none;">
                            <h3 class="text-lg font-bold text-green-800">üìä Tu TFCPSI Calculado:</h3>
                            <p class="text-sm text-green-700">TFCPSI = (NACPDSI √ó 1,000,000) / HHT</p>
                            <p class="text-lg text-green-900 mt-2">Tu TFCPSI = <strong id="tfcpsi-calculado" class="text-xl"> - </strong></p>
                        </div>

                        <h3 class="text-xl font-semibold text-gray-700 mt-8 mb-4">Proyecci√≥n (Pr√≥ximos 12 Meses)</h3>
                        <div class="mb-6">
                            <label for="hht-futuras" class="block text-gray-700 font-medium mb-2">HHT - Horas Hombre Trabajadas Proyectadas (para los pr√≥ximos 12 Meses):</label>
                            <span class="block text-sm text-gray-500 mb-2">Total de Horas Hombre Trabajadas esperadas para un **Pr√≥ximos 12 Meses**.</span>
                            <input type="number" id="hht-futuras" placeholder="Ejemplo: 550000" min="1" step="1" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-cier-blue">
                        </div>
                    </div>
                    
                    <!-- NUEVA SECCI√ìN: AN√ÅLISIS DE CAUSAS RA√çZ (CHECKBOXES PARA M√ìVIL) -->
                    <div class="p-6 bg-gray-100 rounded-lg border border-gray-200 mt-8">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                            <span class="text-accent-blue mr-2">üîé</span> Tipolog√≠a de Accidentes - An√°lisis de Causas Ra√≠z (Pareto)
                        </h3>
                        <p class="block text-sm text-gray-500 mb-4">Seleccione las ** TRES (3) tipolog√≠as de accidentes** que M√ÅS han afectado a su empresa en los √∫ltimos DOCE (12) MESES. (Toque para seleccionar/deseleccionar)</p>
                        
                        <div id="tipologia-selector-container" class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-96 overflow-y-auto pr-2">
                            <!-- Opciones generadas din√°micamente o a√±adidas aqu√≠ -->
                            
                            <!-- Opci√≥n 1 -->
                            <input type="checkbox" id="tipologia-1" name="tipologia" value="Ca√≠das de personas a Nivel y/o Altura" data-percent="18.4" class="tipologia-checkbox hidden">
                            <label for="tipologia-1" class="tipologia-card p-3 border-2 border-gray-300 rounded-lg shadow-sm block text-gray-700 text-sm font-medium">
                                Ca√≠das de personas a Nivel y/o Altura <span class="text-gray-500 font-normal float-right"></span>
                            </label>
                            
                            <!-- Opci√≥n 2 -->
                            <input type="checkbox" id="tipologia-2" name="tipologia" value="Golpes por objetos" data-percent="17.7" class="tipologia-checkbox hidden">
                            <label for="tipologia-2" class="tipologia-card p-3 border-2 border-gray-300 rounded-lg shadow-sm block text-gray-700 text-sm font-medium">
                                Golpes por objetos <span class="text-gray-500 font-normal float-right"></span>
                            </label>

                            <!-- Opci√≥n 3 -->
                            <input type="checkbox" id="tipologia-3" name="tipologia" value="Esfuerzos excesivos" data-percent="16.2" class="tipologia-checkbox hidden">
                            <label for="tipologia-3" class="tipologia-card p-3 border-2 border-gray-300 rounded-lg shadow-sm block text-gray-700 text-sm font-medium">
                                Esfuerzos excesivos <span class="text-gray-500 font-normal float-right"></span>
                            </label>

                            <!-- Opci√≥n 4 -->
                            <input type="checkbox" id="tipologia-4" name="tipologia" value="Otras formas de accidentes" data-percent="12.5" class="tipologia-checkbox hidden">
                            <label for="tipologia-4" class="tipologia-card p-3 border-2 border-gray-300 rounded-lg shadow-sm block text-gray-700 text-sm font-medium">
                                Otras formas de accidentes <span class="text-gray-500 font-normal float-right"></span>
                            </label>
                            
                            <!-- Opci√≥n 5 -->
                            <input type="checkbox" id="tipologia-5" name="tipologia" value="Choques Veh√≠culo" data-percent="7.7" class="tipologia-checkbox hidden">
                            <label for="tipologia-5" class="tipologia-card p-3 border-2 border-gray-300 rounded-lg shadow-sm block text-gray-700 text-sm font-medium">
                                Choques Veh√≠culo <span class="text-gray-500 font-normal float-right"></span>
                            </label>

                            <!-- Opci√≥n 6 -->
                            <input type="checkbox" id="tipologia-6" name="tipologia" value="Malas pisadas" data-percent="6.1" class="tipologia-checkbox hidden">
                            <label for="tipologia-6" class="tipologia-card p-3 border-2 border-gray-300 rounded-lg shadow-sm block text-gray-700 text-sm font-medium">
                                Malas pisadas <span class="text-gray-500 font-normal float-right"></span>
                            </label>

                            <!-- Opci√≥n 7 -->
                            <input type="checkbox" id="tipologia-7" name="tipologia" value="Golpe por ca√≠das de objetos" data-percent="4.7" class="tipologia-checkbox hidden">
                            <label for="tipologia-7" class="tipologia-card p-3 border-2 border-gray-300 rounded-lg shadow-sm block text-gray-700 text-sm font-medium">
                                Golpe por ca√≠das de objetos <span class="text-gray-500 font-normal float-right"></span>
                            </label>
                            
                            <!-- Opci√≥n 8 -->
                            <input type="checkbox" id="tipologia-8" name="tipologia" value="Atrapamiento por un objeto o entre objetos" data-percent="4.2" class="tipologia-checkbox hidden">
                            <label for="tipologia-8" class="tipologia-card p-3 border-2 border-gray-300 rounded-lg shadow-sm block text-gray-700 text-sm font-medium">
                                Atrapamiento por un objeto o entre objetos <span class="text-gray-500 font-normal float-right"></span>
                            </label>
                            
                            <!-- Opci√≥n 9 -->
                            <input type="checkbox" id="tipologia-9" name="tipologia" value="Contacto con electricidad" data-percent="3.5" class="tipologia-checkbox hidden">
                            <label for="tipologia-9" class="tipologia-card p-3 border-2 border-gray-300 rounded-lg shadow-sm block text-gray-700 text-sm font-medium">
                                Contacto con electricidad <span class="text-gray-500 font-normal float-right"></span>
                            </label>
                            
                            <!-- Opci√≥n 10 -->
                            <input type="checkbox" id="tipologia-10" name="tipologia" value="Picadura de insectos, otros" data-percent="2.5" class="tipologia-checkbox hidden">
                            <label for="tipologia-10" class="tipologia-card p-3 border-2 border-gray-300 rounded-lg shadow-sm block text-gray-700 text-sm font-medium">
                                Picadura de insectos, otros <span class="text-gray-500 font-normal float-right"></span>
                            </label>
                            
                        </div>
                    </div>

                    
                    <div class="text-center mt-8">
                        <button onclick="analizarYPredecir()" id="btn-analizar" class="bg-cier-blue text-white px-10 py-4 text-lg font-semibold rounded-full shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition duration-300 ease-in-out hover:bg-opacity-90">
                            Analizar y Comparar
                        </button>
                    </div>
                </section>
                
                <!-- SECCI√ìN ELIMINADA (GEMINI API) -->
                <!-- <section class="mb-12 p-6 bg-white rounded-xl shadow-lg border-l-4 border-accent-blue">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <span class="text-accent-blue mr-2">ü§ñ</span> Herramientas de Inteligencia Artificial (Gemini)
                    </h2>
                    <p class="text-gray-600 mb-4">Utilice el poder de la IA para generar contenido estrat√©gico basado en su an√°lisis de accidentalidad y sus focos de riesgo seleccionados.</p>
                    
                    <div class="flex flex-col sm:flex-row gap-4 mt-4">
                        <button onclick="generarPlanEstrategicoLLM()" id="btn-gemini-plan" class="w-full bg-success-dark text-white px-6 py-3 text-lg font-semibold rounded-lg shadow-md hover:shadow-xl transition duration-300 ease-in-out hover:bg-opacity-90">
                            Generar Plan Estrat√©gico (IA) ‚ú®
                        </button>
                    </div>
                </section>
                
                <div id="gemini-results" class="mb-12 hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <span class="text-accent-blue mr-2">‚ú®</span> Plan de Acci√≥n Generado por IA
                    </h2>
                    <div id="gemini-loading" class="hidden"></div>
                    <div id="gemini-output" class="p-6 bg-white rounded-xl shadow-lg border-l-4 border-success-dark">
                    </div>
                </div> -->

                <!-- SECCI√ìN DE RESULTADOS DIN√ÅMICA -->
                <div class="resultados hidden fade-in" id="resultados">
                    <!-- Contenido din√°mico del resultado -->
                </div>
            </div>

            <!-- FOOTER -->
            <footer class="bg-gray-100 p-6 text-center text-sm text-gray-600 border-t border-gray-200">
                <p class="font-bold text-gray-800">Calculadora de Accidentalidad para Personal Propio CIER 2025</p>
                <p>Comisi√≥n de Integraci√≥n Energ√©tica Regional</p>
                <p>Coordinaci√≥n Internacional del √Årea Corporativa y Cordinaci√≥n T√©cnica Internacional de SST CIER</p>
                <p class="mt-2 text-xs">Metodolog√≠a: Distribuci√≥n Log-normal validada estad√≠sticamente (p-valor KS = 0.98).</p>
            </footer>
        </div>
    </div>


    <script>
// ============================================
// CALCULADORA DE ACCIDENTALIDAD CIER 2025
// VERSI√ìN CORREGIDA CON DISTRIBUCI√ìN LOG-NORMAL
// ============================================

// Datos reales CIER 2025 (42 empresas)
const datosCIER = [
    6.494611421, 38.82800285, 6.796793308, 144.7876448, 1.828367487,
    1.119837131, 1.661937347, 0.485178288, 12.63178789, 1.030333004,
    2.045010685, 8.233677545, 77.60721437, 8.99261167, 0.6816614,
    5.212626284, 3.430539578, 0, 8.132196994, 11.24242682, 11.67365237,
    3.85310879, 32.32200718, 14.16493193, 17.71975823, 23.32650032,
    0, 24.09822436, 3.950807703, 37.37128026, 23.9092133, 6.592827004,
    0.74718823, 0.903252409, 0.420180602, 2.105733069, 7.499521184,
    0, 3.971058923, 7.092869826, 9.731084718, 0
];

// Datos Pareto (sin cambios - ya estaba correcto)
const datosPareto = {
    "Ca√≠das de personas a Nivel y/o Altura": { 
        percent: 18.4, 
        riesgo: "Alto", 
        sugerencias: [
            "Refuerzo en protocolos de trabajo en altura (arneses, l√≠neas de vida).", 
            "Inspecci√≥n rigurosa de andamios, escaleras y plataformas.", 
            "Capacitaci√≥n espec√≠fica en rescate en altura."
        ]
    },
    "Golpes por objetos": { 
        percent: 17.7, 
        riesgo: "Alto", 
        sugerencias: [
            "Uso obligatorio y permanente de Equipo de Protecci√≥n Personal (EPP) de cabeza y manos.", 
            "Mejora del orden y limpieza en √°reas de trabajo.", 
            "An√°lisis de riesgo en manejo de herramientas y materiales."
        ]
    },
    "Esfuerzos excesivos": { 
        percent: 16.2, 
        riesgo: "Alto", 
        sugerencias: [
            "Entrenamiento en ergonom√≠a y t√©cnicas correctas de levantamiento de cargas.", 
            "Implementaci√≥n de ayudas mec√°nicas para tareas repetitivas o pesadas.", 
            "Rotaci√≥n de tareas para prevenir fatiga muscular."
        ]
    },
    "Otras formas de accidentes": { 
        percent: 12.5, 
        riesgo: "Medio", 
        sugerencias: [
            "Revisi√≥n profunda de los incidentes para identificar categor√≠as no cubiertas.", 
            "Fomentar el reporte de casi-accidentes para capturar riesgos diversos.", 
            "Campa√±a de concientizaci√≥n sobre el riesgo residual."
        ]
    },
    "Choques Veh√≠culo": { 
        percent: 7.7, 
        riesgo: "Medio", 
        sugerencias: [
            "Capacitaci√≥n obligatoria en conducci√≥n defensiva y manejo 4x4.", 
            "Mantenimiento estricto de la flota y uso de tecnolog√≠as de monitoreo de velocidad.", 
            "Reforzar el protocolo de descanso en rutas largas."
        ]
    },
    "Malas pisadas": { 
        percent: 6.1, 
        riesgo: "Medio", 
        sugerencias: [
            "Mantenimiento de zonas de paso y se√±alizaci√≥n de desniveles.", 
            "Uso de calzado de seguridad con agarre apropiado.", 
            "Campa√±a de concientizaci√≥n sobre atenci√≥n al camino."
        ]
    },
    "Golpe por ca√≠das de objetos": { 
        percent: 4.7, 
        riesgo: "Bajo", 
        sugerencias: [
            "Protocolos obligatorios para asegurar herramientas y materiales en altura.", 
            "Uso de redes de seguridad o zonas de exclusi√≥n por debajo de trabajos elevados.", 
            "Verificaci√≥n de anclajes y sistemas de izado."
        ]
    },
    "Atrapamiento por un objeto o entre objetos": { 
        percent: 4.2, 
        riesgo: "Bajo", 
        sugerencias: [
            "Implementaci√≥n del protocolo LOTO (Lockout/Tagout) para energ√≠as peligrosas.", 
            "Distanciamiento de seguridad en maquinaria en movimiento.", 
            "Capacitaci√≥n en riesgos mec√°nicos."
        ]
    },
    "Contacto con electricidad": { 
        percent: 3.5, 
        riesgo: "Bajo", 
        sugerencias: [
            "Refuerzo en los 5 pasos de oro de seguridad el√©ctrica.", 
            "Auditor√≠a de EPP diel√©ctrico y herramientas aisladas.", 
            "Campa√±a de concientizaci√≥n sobre l√≠neas vivas o desenergizadas."
        ]
    },
    "Picadura de insectos, otros": { 
        percent: 2.5, 
        riesgo: "Bajo", 
        sugerencias: [
            "Uso de repelentes y ropa adecuada para trabajos en campo.", 
            "Inspecci√≥n previa de √°reas de trabajo boscosas/rurales.", 
            "Protocolo claro de primeros auxilios para picaduras."
        ]
    }
};

// ============================================
// FUNCIONES ESTAD√çSTICAS CON LOG-NORMAL
// ============================================

/**
 * Calcula estad√≠sticos descriptivos y par√°metros de distribuci√≥n Log-normal
 * @param {Array} datos - Array de tasas de frecuencia
 * @returns {Object} Objeto con estad√≠sticos y par√°metros Log-normal
 */
function calcularEstadisticas(datos) {
    const n = datos.length;
    const datosOrdenados = [...datos].sort((a, b) => a - b);
    
    // Estad√≠sticos b√°sicos
    const promedio = datos.reduce((a, b) => a + b, 0) / n;
    const mediana = n % 2 === 0 
        ? (datosOrdenados[n/2 - 1] + datosOrdenados[n/2]) / 2 
        : datosOrdenados[Math.floor(n/2)];
    
    const varianza = datos.reduce((sum, val) => sum + Math.pow(val - promedio, 2), 0) / n;
    const desviacion = Math.sqrt(varianza);
    const minimo = Math.min(...datos);
    const maximo = Math.max(...datos);
    
    // Coeficiente de variaci√≥n
    const cv = (desviacion / promedio) * 100;
    
    // PAR√ÅMETROS LOG-NORMAL (CORRECCI√ìN PRINCIPAL)
    // Filtramos ceros porque log(0) no est√° definido
    const datosSinCeros = datos.filter(x => x > 0);
    const datosLog = datosSinCeros.map(x => Math.log(x));
    
    const mediaLog = datosLog.reduce((a, b) => a + b, 0) / datosLog.length;
    const varianzaLog = datosLog.reduce((sum, val) => sum + Math.pow(val - mediaLog, 2), 0) / datosLog.length;
    const sigmaLog = Math.sqrt(varianzaLog);
    
    // Par√°metros de Log-normal
    const muLog = mediaLog;      // Œº (par√°metro de localizaci√≥n)
    const sigmaLogParam = sigmaLog;  // œÉ (par√°metro de forma)
    
    // Tambi√©n calculamos Gamma por referencia (pero NO la usamos para clasificaci√≥n)
    const shapeK = Math.pow(promedio, 2) / varianza;
    const scaleTheta = varianza / promedio;
    
    return { 
        n, 
        promedio, 
        mediana, 
        desviacion,
        cv,
        minimo, 
        maximo, 
        datosOrdenados,
        // Par√°metros Log-normal (LOS CORRECTOS)
        muLog,
        sigmaLog: sigmaLogParam,
        datosSinCeros,
        // Par√°metros Gamma (solo para referencia)
        shapeK,
        scaleTheta
    };
}

/**
 * Calcula percentiles de distribuci√≥n Log-normal
 * @param {number} p - Percentil deseado (0.10, 0.25, 0.50, 0.75, 0.90)
 * @param {number} mu - Par√°metro Œº de Log-normal
 * @param {number} sigma - Par√°metro œÉ de Log-normal
 * @returns {number} Valor del percentil
 */
function percentilLogNormal(p, mu, sigma) {
    // Valores z de la distribuci√≥n normal est√°ndar para percentiles comunes
    const zValues = {
        0.05: -1.6449,
        0.10: -1.2816,
        0.25: -0.6745,
        0.50: 0,
        0.75: 0.6745,
        0.90: 1.2816,
        0.95: 1.6449
    };
    
    const z = zValues[p];
    if (z === undefined) {
        console.error(`Percentil ${p} no soportado`);
        return 0;
    }
    
    // F√≥rmula del percentil Log-normal: exp(Œº + œÉ*z)
    return Math.exp(mu + sigma * z);
}

/**
 * Calcula la Funci√≥n de Distribuci√≥n Acumulada (CDF) de Log-normal
 * √ötil para calcular percentiles exactos de un valor observado
 * @param {number} x - Valor a evaluar
 * @param {number} mu - Par√°metro Œº de Log-normal
 * @param {number} sigma - Par√°metro œÉ de Log-normal
 * @returns {number} Probabilidad acumulada (0 a 1)
 */
function cdfLogNormal(x, mu, sigma) {
    if (x <= 0) return 0;
    
    // Transformar a distribuci√≥n normal est√°ndar
    const z = (Math.log(x) - mu) / sigma;
    
    // Aproximaci√≥n de la CDF normal est√°ndar (Œ¶(z))
    // Aproximaci√≥n de Abramowitz y Stegun
    const t = 1 / (1 + 0.2316419 * Math.abs(z));
    const d = 0.3989423 * Math.exp(-z * z / 2);
    const p = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
    
    return z > 0 ? 1 - p : p;
}

/**
 * Calcula el percentil exacto de un valor dado usando CDF Log-normal
 * @param {number} valor - Valor observado (TFCPSI)
 * @param {number} mu - Par√°metro Œº de Log-normal
 * @param {number} sigma - Par√°metro œÉ de Log-normal
 * @returns {number} Percentil (0-100)
 */
function calcularPercentilExacto(valor, mu, sigma) {
    const probabilidad = cdfLogNormal(valor, mu, sigma);
    return probabilidad * 100;
}

// Calcular estad√≠sticas y par√°metros al cargar
const stats = calcularEstadisticas(datosCIER);

// Calcular percentiles Log-normal (CORRECCI√ìN PRINCIPAL)
const percentilesLogNormal = {
    p05: percentilLogNormal(0.05, stats.muLog, stats.sigmaLog),
    p10: percentilLogNormal(0.10, stats.muLog, stats.sigmaLog),
    p25: percentilLogNormal(0.25, stats.muLog, stats.sigmaLog),
    p50: percentilLogNormal(0.50, stats.muLog, stats.sigmaLog),
    p75: percentilLogNormal(0.75, stats.muLog, stats.sigmaLog),
    p90: percentilLogNormal(0.90, stats.muLog, stats.sigmaLog),
    p95: percentilLogNormal(0.95, stats.muLog, stats.sigmaLog)
};

// Mostrar en consola para verificaci√≥n
console.log("=== PAR√ÅMETROS LOG-NORMAL ===");
console.log(`Œº (mu): ${stats.muLog.toFixed(4)}`);
console.log(`œÉ (sigma): ${stats.sigmaLog.toFixed(4)}`);
console.log("\n=== PERCENTILES LOG-NORMAL ===");
console.log(`P5:  ${percentilesLogNormal.p05.toFixed(2)}`);
console.log(`P10: ${percentilesLogNormal.p10.toFixed(2)}`);
console.log(`P25: ${percentilesLogNormal.p25.toFixed(2)}`);
console.log(`P50: ${percentilesLogNormal.p50.toFixed(2)}`);
console.log(`P75: ${percentilesLogNormal.p75.toFixed(2)}`);
console.log(`P90: ${percentilesLogNormal.p90.toFixed(2)}`);
console.log(`P95: ${percentilesLogNormal.p95.toFixed(2)}`);

// ============================================
// FUNCIONES DE AN√ÅLISIS Y CLASIFICACI√ìN
// ============================================

/**
 * Formatea n√∫meros con separador de miles
 */
function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

/**
 * Calcula TFCPSI en tiempo real
 */
function calcularTFCPSI() {
    const nacpdsi = parseFloat(document.getElementById('nacpdsi').value);
    const hht = parseFloat(document.getElementById('hht').value);
    const infoTfcpsiDiv = document.getElementById('info-tfcpsi');
    
    if (!isNaN(nacpdsi) && !isNaN(hht) && hht > 0) {
        const tfcpsi = (nacpdsi * 1000000) / hht;
        document.getElementById('tfcpsi-calculado').textContent = tfcpsi.toFixed(2);
        infoTfcpsiDiv.style.display = 'block';
    } else {
        infoTfcpsiDiv.style.display = 'none';
    }
}

/**
 * Analiza el TFCPSI de la empresa usando distribuci√≥n Log-normal
 * @param {number} tfcpsi - Tasa de frecuencia calculada
 * @param {Object} stats - Estad√≠sticos del sector
 * @returns {Object} An√°lisis completo de la posici√≥n
 */
function analizarTFCPSI(tfcpsi, stats) {
    // Calcular percentil exacto usando CDF Log-normal
    const percentil = calcularPercentilExacto(tfcpsi, stats.muLog, stats.sigmaLog);
    
    // Calcular posici√≥n en el ranking emp√≠rico
    let posicion = 0;
    for (let i = 0; i < stats.datosOrdenados.length; i++) {
        if (tfcpsi <= stats.datosOrdenados[i]) {
            posicion = i + 1;
            break;
        }
    }
    if (posicion === 0) posicion = stats.datosOrdenados.length + 1;
    
    // Z-Score
    const zScore = (tfcpsi - stats.promedio) / stats.desviacion;
    
    // Diferencia porcentual respecto al promedio
    const diferenciaPorcentaje = ((tfcpsi - stats.promedio) / stats.promedio) * 100;
    
    // CLASIFICACI√ìN BASADA EN PERCENTILES LOG-NORMAL (CORRECCI√ìN)
    let clasificacion, colorClase, interpretacion;
    
    if (percentil <= 25) { 
        clasificacion = "EXCELENTE";
        colorClase = "excelente";
        interpretacion = "Tu desempe√±o te sit√∫a entre el TOP 25% de las empresas del sector. ¬°Eres un l√≠der en seguridad!";
    } else if (percentil <= 50) {
        clasificacion = "BUENO";
        colorClase = "bueno";
        interpretacion = "Tu desempe√±o est√° en la mitad superior del sector. Tienes buen rendimiento con potencial de mejora.";
    } else if (percentil <= 75) {
        clasificacion = "REGULAR";
        colorClase = "regular";
        interpretacion = "Tu desempe√±o est√° en la mitad inferior del sector. Requiere un plan de acci√≥n para alcanzar la Mediana.";
    } else {
        clasificacion = "NECESITA MEJORAR";
        colorClase = "mejorar";
        interpretacion = "Tu desempe√±o est√° en el cuartil de mayor accidentalidad. Se requieren acciones de mejora urgentes.";
    }
    
    return { 
        posicion, 
        percentil, 
        zScore, 
        clasificacion, 
        colorClase, 
        interpretacion, 
        diferenciaPorcentaje 
    };
}

/**
 * Proyecta accidentes futuros con intervalos de confianza (Modelo Poisson)
 * @param {number} tfcpsi - Tasa de frecuencia actual
 * @param {number} hhtFuturas - Horas hombre proyectadas
 * @returns {Object} Proyecci√≥n con intervalos
 */
function proyeccionAccidentesConIncertidumbre(tfcpsi, hhtFuturas) {
    // Expectativa puntual (Œª de Poisson)
    const lambda = (tfcpsi * hhtFuturas) / 1000000;
    
    // En Poisson: E[X] = Œª, Var[X] = Œª
    const desviacion = Math.sqrt(lambda);
    
    // Intervalo de confianza 95% (aproximaci√≥n normal cuando Œª > 10)
    // Para Œª peque√±os, usar tabla Poisson exacta (aqu√≠ usamos aproximaci√≥n)
    const z95 = 1.96;
    const limite_inferior = Math.max(0, lambda - z95 * desviacion);
    const limite_superior = lambda + z95 * desviacion;
    
    // Intervalo 80% (m√°s realista)
    const z80 = 1.282;
    const limite_inferior_80 = Math.max(0, lambda - z80 * desviacion);
    const limite_superior_80 = lambda + z80 * desviacion;
    
    return {
        esperado: lambda,
        desviacion: desviacion,
        ic95_inferior: limite_inferior,
        ic95_superior: limite_superior,
        ic80_inferior: limite_inferior_80,
        ic80_superior: limite_superior_80
    };
}

/**
 * Funci√≥n principal de an√°lisis y predicci√≥n
 */
function analizarYPredecir() {
    const nacpdsi = parseFloat(document.getElementById('nacpdsi').value);
    const hht = parseFloat(document.getElementById('hht').value);
    const hhtFuturas = parseFloat(document.getElementById('hht-futuras').value);
    
    // Validaci√≥n de datos TFCPSI
    if (isNaN(nacpdsi) || isNaN(hht) || hht <= 0 || isNaN(hhtFuturas) || hhtFuturas <= 0) {
        alert('Paso 1 requerido: Por favor, ingresa NACPDSI, HHT y HHT Proyectadas v√°lidos.');
        return;
    }

    // Validaci√≥n de selecci√≥n de riesgos
    const tipologiaCheckboxes = document.querySelectorAll('input[name="tipologia"]:checked');
    if (tipologiaCheckboxes.length === 0) {
        alert('Paso 2 requerido: Por favor, selecciona al menos una Tipolog√≠a de Caso para el An√°lisis Pareto.');
        return;
    }
    
    const tfcpsi = (nacpdsi * 1000000) / hht;
    const resultado = analizarTFCPSI(tfcpsi, stats);
    
    // Generar HTML de resultados
    let html = generarSeccionExplicacion();
    html += generarResultadoPrincipal(tfcpsi, resultado);
    html += generarSeccionTipologia(Array.from(tipologiaCheckboxes).map(checkbox => ({
        tipologia: checkbox.value,
        percent: parseFloat(checkbox.dataset.percent)
    })));
    html += generarSeccionPosicion(resultado);
    html += generarSeccionComparacion(tfcpsi, resultado);
    html += generarSeccionPrediccion(tfcpsi, hhtFuturas);
    html += generarSeccionPercentiles();
    html += generarSeccionRecomendaciones(resultado, hhtFuturas, tfcpsi);
    html += generarSeccionSensibilidad(tfcpsi, hhtFuturas);
    html += generarSeccionMetodologia(); // NUEVA SECCI√ìN
    
    // Mostrar resultados
    const resultadosDiv = document.getElementById('resultados');
    resultadosDiv.innerHTML = html;
    resultadosDiv.classList.remove('hidden');
    resultadosDiv.classList.add('fade-in');
    resultadosDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ============================================
// FUNCIONES GENERADORAS DE HTML
// ============================================

function generarSeccionExplicacion() {
    const filas = [
        { class: 'bg-success-light border-success-dark', clasificacion: 'EXCELENTE', rango: 'Menor o igual al 25%', significado: 'Su TFCPSI es mejor que el 75% de las empresas del sector (L√≠der).' },
        { class: 'bg-gray-50 border-success-dark', clasificacion: 'BUENO', rango: 'Entre 25% y 50%', significado: 'Su desempe√±o est√° en la mitad superior. Potencial de ascenso.' },
        { class: 'bg-warning-light border-yellow-500', clasificacion: 'REGULAR', rango: 'Entre 50% y 75%', significado: 'Se encuentra en la mitad inferior. La Mediana es su primera meta.' },
        { class: 'bg-danger-light border-red-500', clasificacion: 'NECESITA MEJORAR', rango: 'Mayor al 75%', significado: 'Est√° en el cuartil de mayor riesgo. Acci√≥n urgente.' }
    ];

    const contenidoFilas = filas.map(fila => `
        <div class="p-4 rounded-lg border-l-4 ${fila.class} grid grid-cols-1 md:grid-cols-3 gap-1 md:gap-3 items-center shadow-sm">
            <span class="text-sm font-bold md:col-span-1 text-gray-800">${fila.clasificacion}</span>
            <span class="text-sm text-gray-700 md:col-span-1"><span class="mobile-label">Percentil:</span> ${fila.rango}</span>
            <span class="text-sm text-gray-700 md:col-span-1"><span class="mobile-label">Significado:</span> ${fila.significado}</span>
        </div>
    `).join('');

    return `
        <section class="mb-12 p-6 bg-white rounded-xl shadow-lg border-l-4 border-success-dark">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <span class="text-success-dark mr-2">‚≠ê</span> Criterio de Clasificaci√≥n: El Poder del Percentil
            </h2>
            <p class="text-gray-600 mb-6">La accidentalidad es asim√©trica, por eso no usamos el promedio simple. Su clasificaci√≥n se basa en su **Percentil Log-normal**, que indica qu√© tan bien se desempe√±a su empresa comparada con las 42 empresas del sector.</p>

            <div class="space-y-3">
                <div class="hidden md:grid md:grid-cols-3 gap-3 px-4 py-2 bg-cier-blue text-white rounded-lg text-xs font-medium uppercase">
                    <span>Clasificaci√≥n</span>
                    <span>Rango de Percentil</span>
                    <span>Significado Pr√°ctico</span>
                </div>
                ${contenidoFilas}
            </div>
        </section>
    `;
}

function generarResultadoPrincipal(tfcpsi, resultado) {
    return `
        <div class="p-8 text-white text-center rounded-xl mb-8 shadow-xl bg-cier-blue">
            <h2 class="text-3xl font-semibold mb-2">Tu Resultado de Accidentalidad</h2>
            <div class="text-sm opacity-80 mb-6">Distribuci√≥n & Integradas | Personal Propio | CIER 2025</div>
            <div class="text-xl font-medium opacity-90">Tu Tasa de Frecuencia (TFCPSI)</div>
            <div class="text-6xl font-extrabold my-4 tracking-tight tfcpsi-valor">${tfcpsi.toFixed(2)}</div>
            <div class="inline-block px-8 py-2 rounded-full text-xl font-bold uppercase shadow-lg text-white bg-${resultado.colorClase} clasificacion">
                ${resultado.clasificacion}
            </div>
            <div class="text-lg mt-4 p-3 bg-white bg-opacity-20 rounded-lg">${resultado.interpretacion}</div>
            <div class="text-sm mt-3 opacity-75">Percentil Log-normal: ${resultado.percentil.toFixed(1)}%</div>
        </div>
    `;
}

function generarSeccionTipologia(seleccionTipologia) {
    const totalPercent = seleccionTipologia.reduce((sum, item) => sum + item.percent, 0);

    let sugerenciasUnicas = new Set();
    seleccionTipologia.forEach(item => {
        const data = datosPareto[item.tipologia];
        if (data && data.sugerencias) {
            data.sugerencias.forEach(sug => sugerenciasUnicas.add(sug));
        }
    });

    const sugerenciasFinales = Array.from(sugerenciasUnicas).slice(0, 3);
    
    let tipologiaHtml = seleccionTipologia.map(item => `
        <div class="grid grid-cols-2 py-2 px-4 border-b border-gray-100 last:border-b-0">
            <span class="text-gray-700 font-medium">${item.tipologia}</span>
            <span class="font-bold text-accent-blue text-right">${item.percent.toFixed(1)}%</span>
        </div>
    `).join('');

    let sugerenciasHtml = sugerenciasFinales.map(sug => `
        <li class="p-3 border-b last:border-b-0 text-gray-700 relative pl-6">
            <span class="absolute left-0 top-3 text-lg text-success-dark">‚úî</span> ${sug}
        </li>
    `).join('');

    let coincidenciaTexto;
    if (totalPercent > 50) {
        coincidenciaTexto = "Alta coincidencia. Los accidentes que le preocupan en su empresa son los principales accidentes del sector el√©ctrico en la regi√≥n CIER.";
    } else if (totalPercent > 25) {
        coincidenciaTexto = "Coincidencia moderada. Los accidentes que le preocupan se alinean con una parte significativa de los accidentes del sector el√©ctrico en la regi√≥n CIER.";
    } else {
        coincidenciaTexto = "Coincidencia baja. Si bien son accidentes importantes en su empresa, el sector el√©ctrico de la regi√≥n CIER tiene otro tipo de accidentes que preocupan."  
    }

    return `
        <section class="mb-12 p-6 bg-white rounded-xl shadow-lg border-l-4 border-accent-blue">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <span class="text-accent-blue mr-2">üéØ</span> Cuadro comparativo de tipolog√≠a de accidentes hist√≥rica en su empresa con la registrada por empresas de la CIER. An√°lisis Pareto y Sugerencias Proactivas
            </h2>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div class="p-5 bg-gray-50 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Tu Foco vs. Distribuci√≥n CIER</h3>
                    <div class="text-sm text-gray-600 mb-4">
                        Los porcentajes son la media de ocurrencia por tipolog√≠a seg√∫n la **muestra de empresas CIER**.
                        <p class="font-bold mt-2 text-cier-blue">${coincidenciaTexto}</p>
                        <p class="font-extrabold mt-2 text-xl text-success-dark">Total Riesgo Seleccionado: ${totalPercent.toFixed(1)}%</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-inner divide-y divide-gray-100">
                        <div class="grid grid-cols-2 font-bold bg-gray-100 py-2 px-4 rounded-t-lg border-b border-gray-200">
                            <span>Tu Foco</span>
                            <span class="text-right">Distribuci√≥n CIER (%)</span>
                        </div>
                        ${tipologiaHtml}
                    </div>
                </div>

                <div class="p-5 bg-cier-light-blue rounded-lg border border-cier-blue">
                    <h3 class="text-xl font-bold text-cier-blue mb-4">3 Sugerencias Clave para Mejorar</h3>
                    <p class="text-sm text-gray-700 mb-4">Basado en la severidad de sus prioridades y las pr√°cticas del sector:</p>
                    <ul class="list-none space-y-2 bg-white p-3 rounded-lg shadow-sm">
                        ${sugerenciasHtml}
                    </ul>
                </div>
            </div>
        </section>
    `;
}

function generarSeccionPosicion(resultado) {
    return `
        <section class="mb-12 p-6 bg-white rounded-xl shadow-lg border-l-4 border-cier-blue">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <span class="text-cier-blue mr-2">üìç</span> Tu Posici√≥n en el Sector
            </h2>
            
            <div class="bg-warning-light border-l-4 border-yellow-500 p-3 mb-6 text-sm text-yellow-800 rounded-md">
                <strong class="text-yellow-900">Gu√≠a de Percentil:</strong> Un percentil m√°s bajo significa mejor desempe√±o. El ${resultado.percentil.toFixed(1)}% indica que el ${resultado.percentil.toFixed(1)}% de las empresas tienen una tasa igual o menor a la tuya (calculado con distribuci√≥n Log-normal).
            </div>
            
            <div class="h-10 bg-gray-200 rounded-full overflow-hidden my-4 shadow-inner">
                <div class="progreso-fill h-full flex items-center justify-center text-white text-sm font-bold" style="width: ${resultado.percentil}%">
                    Percentil ${resultado.percentil.toFixed(1)}%
                </div>
            </div>
            
            <div class="grid md:grid-cols-3 gap-6 mt-6">
                <div class="p-5 border border-gray-200 rounded-lg shadow-sm">
                    <h3 class="text-lg font-semibold text-cier-blue mb-2">Posici√≥n Actual</h3>
                    <div class="text-3xl font-extrabold text-gray-800">${resultado.posicion} de ${stats.n}</div>
                    <p class="text-sm text-gray-500 mt-2">${resultado.posicion <= 10 ? '‚úì Entre las 10 mejores del sector' : resultado.posicion <= 21 ? 'En la mitad superior del sector' : resultado.posicion <= 31 ? 'En la mitad inferior del sector' : 'En el cuartil con mayor accidentalidad'}</p>
                </div>
                
                <div class="p-5 border border-gray-200 rounded-lg shadow-sm">
                    <h3 class="text-lg font-semibold text-cier-blue mb-2">Tu Percentil</h3>
                    <div class="text-3xl font-extrabold text-gray-800">${resultado.percentil.toFixed(1)}%</div>
                    <p class="text-sm text-gray-500 mt-2">${resultado.percentil <= 50 ? 'Est√°s mejor que la mitad del sector.' : 'Tienes oportunidades de mejora.'}</p>
                </div>

                <div class="p-5 border border-gray-200 rounded-lg shadow-sm">
                    <h3 class="text-lg font-semibold text-cier-blue mb-2">Z-Score</h3>
                    <div class="text-3xl font-extrabold text-gray-800">${resultado.zScore.toFixed(2)} œÉ</div>
                    <p class="text-sm text-gray-500 mt-2">Mide qu√© tan lejos est√°s del promedio en desviaciones est√°ndar.</p>
                </div>
            </div>
        </section>
    `;
}

function generarSeccionComparacion(tfcpsi, resultado) {
    const difPromedio = tfcpsi - stats.promedio;
    const porcDifPromedio = resultado.diferenciaPorcentaje;
    const difMediana = tfcpsi - stats.mediana;
    
    return `
        <section class="mb-12 p-6 bg-white rounded-xl shadow-lg border-l-4 border-cier-blue">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <span class="text-cier-blue mr-2">üìà</span> Comparaci√≥n de TFCPSI
            </h2>
            
            <div class="grid md:grid-cols-3 gap-6">
                <div class="p-5 border-l-4 ${difPromedio < 0 ? 'border-success-dark bg-success-light' : 'border-red-500 bg-danger-light'} rounded-r-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">vs Promedio Sector</h3>
                    <div class="text-2xl font-bold ${difPromedio < 0 ? 'text-success-dark' : 'text-red-700'}">${difPromedio < 0 ? '‚úì Mejor por' : '‚úó Peor por'} ${Math.abs(difPromedio).toFixed(2)} pts</div>
                    <p class="text-sm text-gray-600 mt-2">Promedio Sector: <strong>${stats.promedio.toFixed(2)}</strong></p>
                    <p class="text-sm font-semibold mt-1">${difPromedio < 0 ? `Est√°s <strong>${Math.abs(porcDifPromedio).toFixed(1)}% MEJOR</strong>` : `Est√°s <strong>${porcDifPromedio.toFixed(1)}% por encima</strong>`}</p>
                </div>
                
                <div class="p-5 border-l-4 ${difMediana < 0 ? 'border-success-dark bg-success-light' : 'border-red-500 bg-danger-light'} rounded-r-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">vs Mediana Sector</h3>
                    <div class="text-2xl font-bold ${difMediana < 0 ? 'text-success-dark' : 'text-red-700'}">${difMediana < 0 ? '‚úì Superior' : '‚úó Inferior'}</div>
                    <p class="text-sm text-gray-600 mt-2">Mediana Sector: <strong>${stats.mediana.toFixed(2)}</strong></p>
                    <p class="text-sm font-semibold mt-1">${difMediana < 0 ? 'Est√°s en la mitad <strong>SUPERIOR</strong>.' : 'Est√°s en la mitad <strong>INFERIOR</strong>.'}</p>
                </div>
                
                <div class="p-5 border-l-4 ${tfcpsi <= percentilesLogNormal.p25 ? 'border-success-dark bg-success-light' : 'border-yellow-500 bg-warning-light'} rounded-r-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">vs Top 25%</h3>
                    <div class="text-2xl font-bold ${tfcpsi <= percentilesLogNormal.p25 ? 'text-success-dark' : 'text-yellow-800'}">‚â§ ${percentilesLogNormal.p25.toFixed(2)}</div>
                    <p class="text-sm text-gray-600 mt-2">Meta de excelencia (percentil 25 Log-normal).</p>
                    <p class="text-sm font-semibold mt-1">${tfcpsi <= percentilesLogNormal.p25 ? '¬°Felicitaciones! Perteneces a los l√≠deres.' : `Necesitas reducir ${(tfcpsi - percentilesLogNormal.p25).toFixed(2)} puntos.`}</p>
                </div>
            </div>
        </section>
    `;
}

function generarSeccionPrediccion(tfcpsi, hhtFuturas) {
    // Proyecci√≥n con incertidumbre
    const proyeccion = proyeccionAccidentesConIncertidumbre(tfcpsi, hhtFuturas);
    
    const accidentesPromedio = (stats.promedio * hhtFuturas) / 1000000;
    const accidentesMediana = (stats.mediana * hhtFuturas) / 1000000;
    const accidentesP25 = (percentilesLogNormal.p25 * hhtFuturas) / 1000000;
    
    const tfcpsiOptimista = Math.max(0.5, percentilesLogNormal.p10);
    const accidentesOptimista = (tfcpsiOptimista * hhtFuturas) / 1000000;
    
    const difPromedio = proyeccion.esperado - accidentesPromedio;
    const difMediana = proyeccion.esperado - accidentesMediana;
    const difP25 = proyeccion.esperado - accidentesP25;
    
    const hhtProyectadasFormateadas = formatNumber(hhtFuturas);

    const escenarioBox = (title, tfcpsiRef, accidentes, diferencia, esOptimista = false) => {
        const difClase = diferencia < 0 ? 'text-red-600 bg-danger-light' : 'text-success-dark bg-success-light';
        const difTexto = diferencia < 0 
            ? `Tendr√≠as ${Math.abs(diferencia).toFixed(2)} accidentes M√ÅS`
            : `Podr√≠as EVITAR ${Math.abs(diferencia).toFixed(2)} accidentes`;
        
        return `
            <div class="p-5 bg-white rounded-lg shadow-md border-l-4 border-gray-300 hover:border-cier-blue transition duration-300">
                <h3 class="text-lg font-semibold text-gray-700 mb-2 ${esOptimista ? 'text-accent-blue' : ''}">${title}</h3>
                <p class="text-sm text-gray-500">TFCPSI: <strong>${tfcpsiRef.toFixed(2)}</strong></p>
                <div class="text-4xl font-extrabold text-cier-blue my-2">${accidentes.toFixed(2)}</div>
                <div class="mt-2 p-2 rounded-md font-medium text-sm ${difClase}">
                    ${esOptimista ? `‚Üí Objetivo: EVITAR ${(proyeccion.esperado - accidentes).toFixed(2)} accidentes` : (title.includes('Manteniendo') ? 'Tu proyecci√≥n actual' : `‚Üí ${difTexto}`)}
                </div>
            </div>
        `;
    };
    
    return `
        <section class="mb-12 p-6 bg-white rounded-xl shadow-lg border-l-4 border-cier-blue">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <span class="text-cier-blue mr-2">üîÆ</span> Proyecci√≥n de Accidentes (12 Meses Futuros) y Propuesta de Metas (Objetivos) 
            </h2>
            <p class="text-gray-600 mb-4">Proyectado sobre <strong>${hhtProyectadasFormateadas}</strong> Horas Hombre Trabajadas futuras.</p>
            
            <!-- INTERVALO DE CONFIANZA (NUEVO) -->
            <div class="bg-blue-50 border-l-4 border-accent-blue p-5 mb-6 rounded-md">
                <h3 class="text-lg font-bold text-accent-blue mb-3">üìä Intervalo de Confianza (Modelo Poisson)</h3>
                <div class="grid md:grid-cols-3 gap-4 text-center">
                    <div class="p-3 bg-white rounded-lg shadow-sm">
                        <div class="text-sm text-gray-500 font-medium">L√≠mite Inferior (95%)</div>
                        <div class="text-2xl font-extrabold text-gray-700">${proyeccion.ic95_inferior.toFixed(2)}</div>
                    </div>
                    <div class="p-3 bg-white rounded-lg shadow-sm border-2 border-accent-blue">
                        <div class="text-sm text-accent-blue font-bold">Esperado (Œª)</div>
                        <div class="text-3xl font-extrabold text-accent-blue">${proyeccion.esperado.toFixed(2)}</div>
                    </div>
                    <div class="p-3 bg-white rounded-lg shadow-sm">
                        <div class="text-sm text-gray-500 font-medium">L√≠mite Superior (95%)</div>
                        <div class="text-2xl font-extrabold text-gray-700">${proyeccion.ic95_superior.toFixed(2)}</div>
                    </div>
                </div>
                <p class="text-xs text-gray-600 mt-3 text-center">Con 95% de confianza, el n√∫mero real de accidentes estar√° entre ${proyeccion.ic95_inferior.toFixed(1)} y ${proyeccion.ic95_superior.toFixed(1)} accidentes.</p>
            </div>
            
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Escenarios Comparativos</h3>
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${escenarioBox("1Ô∏è‚É£ Manteniendo tu TFCPSI actual", tfcpsi, proyeccion.esperado, 0)}
                ${escenarioBox("2Ô∏è‚É£ Si alcanzas el PROMEDIO del sector", stats.promedio, accidentesPromedio, difPromedio)}
                ${escenarioBox("3Ô∏è‚É£ Si alcanzas la MEDIANA del sector", stats.mediana, accidentesMediana, difMediana)}
                ${escenarioBox("4Ô∏è‚É£ Si entras al TOP 25%", percentilesLogNormal.p25, accidentesP25, difP25)}
                ${escenarioBox("5Ô∏è‚É£ Escenario OPTIMISTA (TOP 10%)", tfcpsiOptimista, accidentesOptimista, proyeccion.esperado - accidentesOptimista, true)}
            </div>
        </section>
    `;
}

function generarSeccionPercentiles() {
    const percentilBox = (label, value, explanation, isTop) => `
        <div class="p-5 bg-white rounded-lg shadow-md border-t-4 ${isTop ? 'border-success-dark' : 'border-gray-300'} text-center transition hover:shadow-xl">
            <div class="text-sm text-gray-500 font-semibold uppercase">${label}</div>
            <div class="text-3xl font-extrabold text-cier-blue mt-1">${value}</div>
            <div class="text-xs text-gray-500 mt-2">${explanation}</div>
        </div>
    `;
    
    return `
        <section class="mb-12 p-6 bg-white rounded-xl shadow-lg border-l-4 border-cier-blue">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <span class="text-cier-blue mr-2">üéØ</span> Percentiles de Referencia (Log-normal)
            </h2>
            <p class="text-gray-600 mb-6">Valores de TFCPSI calculados con distribuci√≥n Log-normal, ideales para establecer metas realistas.</p>
            
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
                ${percentilBox("P5", `‚â§ ${percentilesLogNormal.p05.toFixed(2)}`, "Top 5% del sector", true)}
                ${percentilBox("P10", `‚â§ ${percentilesLogNormal.p10.toFixed(2)}`, "Top 10% del sector", true)}
                ${percentilBox("P25", `‚â§ ${percentilesLogNormal.p25.toFixed(2)}`, "Cuartil superior", true)}
                ${percentilBox("P50", `‚â§ ${percentilesLogNormal.p50.toFixed(2)}`, "Mediana", false)}
                ${percentilBox("P75", `‚â§ ${percentilesLogNormal.p75.toFixed(2)}`, "Tercer cuartil", false)}
                ${percentilBox("P90", `‚â§ ${percentilesLogNormal.p90.toFixed(2)}`, "Percentil 90", false)}
                ${percentilBox("P95", `‚â§ ${percentilesLogNormal.p95.toFixed(2)}`, "Percentil 95", false)}
            </div>
        </section>
    `;
}

function generarSeccionRecomendaciones(resultado, hhtFuturas, tfcpsi) {
    const tfcpsiP25 = percentilesLogNormal.p25;
    const tfcpsiP50 = percentilesLogNormal.p50;
    const tfcpsiP75 = percentilesLogNormal.p75;
    
    const reduccionP25 = tfcpsi > tfcpsiP25 ? ((tfcpsi - tfcpsiP25) * hhtFuturas) / 1000000 : 0;
    const reduccionP50 = tfcpsi > tfcpsiP50 ? ((tfcpsi - tfcpsiP50) * hhtFuturas) / 1000000 : 0;
    const reduccionP75 = tfcpsi > tfcpsiP75 ? ((tfcpsi - tfcpsiP75) * hhtFuturas) / 1000000 : 0;
    
    let title, icon, bgColor, textColor, borderColor, recomendacionesList;

    if (resultado.percentil <= 25) {
        title = "EXCELENTE DESEMPE√ëO - Mant√©n el liderazgo";
        icon = "‚ú®";
        bgColor = 'bg-success-light';
        textColor = 'text-green-800';
        borderColor = 'border-success-dark';
        recomendacionesList = `
            <li><strong>Documenta:</strong> Sistematiza tus mejores pr√°cticas de seguridad para replicarlas.</li>
            <li><strong>Meta:</strong> Mantenerte en el TOP 25% (‚â§ ${tfcpsiP25.toFixed(2)}) y buscar el <strong>cero accidentes fatales</strong>.</li>
            <li><strong>Innovaci√≥n:</strong> Invierte en ergonom√≠a y tecnolog√≠a predictiva (IoT, AI).</li>
        `;
    } else if (resultado.percentil <= 50) {
        title = "BUEN DESEMPE√ëO - Camino al top 25%";
        icon = "üëç";
        bgColor = 'bg-success-light';
        textColor = 'text-green-800';
        borderColor = 'border-success-dark';
        recomendacionesList = `
            <li><strong>Meta realista:</strong> Reducir TFCPSI a <strong>${tfcpsiP25.toFixed(2)}</strong> para entrar al TOP 25%.</li>
            <li><strong>Impacto:</strong> Esto significa evitar aproximadamente <strong>${reduccionP25.toFixed(1)} accidentes</strong> en los pr√≥ximos 12 meses.</li>
            <li><strong>Foco:</strong> Refuerza capacitaci√≥n en puestos de mayor riesgo.</li>
        `;
    } else if (resultado.percentil <= 75) {
        title = "DESEMPE√ëO REGULAR - Plan de mejora necesario";
        icon = "‚ö†Ô∏è";
        bgColor = 'bg-warning-light';
        textColor = 'text-yellow-800';
        borderColor = 'border-yellow-500';
        recomendacionesList = `
            <li><strong>Prioridad:</strong> Implementar un plan estructurado de mejora con m√©tricas claras.</li>
            <li><strong>Meta a corto plazo:</strong> Alcanzar la mediana (<strong>${tfcpsiP50.toFixed(2)}</strong>), evitando <strong>${reduccionP50.toFixed(1)} accidentes</strong>.</li>
            <li><strong>Revisi√≥n:</strong> Auditor√≠a de cumplimiento de procedimientos.</li>
        `;
    } else {
        title = "REQUIERE ATENCI√ìN URGENTE - Acci√≥n inmediata";
        icon = "üö®";
        bgColor = 'bg-danger-light';
        textColor = 'text-red-800';
        borderColor = 'border-red-500';
        recomendacionesList = `
            <li><strong>Liderazgo:</strong> Programa integral de seguridad con <strong>apoyo gerencial inmediato</strong>.</li>
            <li><strong>Meta inmediata:</strong> Reducir a percentil 75 (<strong>${tfcpsiP75.toFixed(2)}</strong>), evitando <strong>${reduccionP75.toFixed(1)} accidentes</strong>.</li>
            <li><strong>Asesor√≠a:</strong> Considerar auditor√≠a externa completa.</li>
        `;
    }

    return `
        <section class="mb-12 p-6 bg-white rounded-xl shadow-lg border-l-4 border-cier-blue">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <span class="text-cier-blue mr-2">üí°</span> Recomendaciones Personalizadas
            </h2>
            <div class="p-6 rounded-xl shadow-inner ${bgColor} ${borderColor} border-l-4">
                <h3 class="text-xl font-bold ${textColor} mb-4">${icon} ${title}</h3>
                <ul class="list-none space-y-3 ${textColor}">
                    ${recomendacionesList}
                </ul>
            </div>
        </section>
    `;
}

function generarSeccionSensibilidad(tfcpsi, hhtFuturas) {
    const accidentesActual = (tfcpsi * hhtFuturas) / 1000000;
    const mejoras = [
        { porcentaje: 10, factor: 0.90 },
        { porcentaje: 20, factor: 0.80 },
        { porcentaje: 30, factor: 0.70 },
        { porcentaje: 50, factor: 0.50 }
    ];
    
    let html = `
        <section class="mb-12 p-6 bg-white rounded-xl shadow-lg border-l-4 border-cier-blue">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <span class="text-cier-blue mr-2">‚ö°</span> An√°lisis de Sensibilidad (ROI de la Seguridad)
            </h2>
            
            <p class="text-gray-600 mb-6">Proyecciones de accidentes evitados si logra reducir su TFCPSI.</p>
            
            <div class="space-y-4">
    `;
    
    mejoras.forEach(mejora => {
        const tfcpsiMejorado = tfcpsi * mejora.factor;
        const accidentesMejorados = (tfcpsiMejorado * hhtFuturas) / 1000000;
        const accidentesEvitados = accidentesActual - accidentesMejorados;
        
        html += `
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition duration-200 flex-wrap gap-2">
                <div class="flex flex-col md:flex-row md:items-center">
                    <span class="font-bold text-lg text-cier-blue">Meta: Reducci√≥n del ${mejora.porcentaje}%</span>
                    <span class="text-sm text-gray-500 md:ml-3">(Nuevo TFCPSI = ${tfcpsiMejorado.toFixed(2)})</span>
                </div>
                <div class="font-extrabold text-xl text-success-dark">
                    EVITAR√çA ${accidentesEvitados.toFixed(2)} ACCIDENTES
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
            
            <div class="bg-blue-50 border-l-4 border-accent-blue p-4 mt-6 text-sm text-gray-800 rounded-md">
                <strong class="text-accent-blue">Valor Econ√≥mico:</strong> Cada accidente evitado representa ahorros significativos en costos m√©dicos, indemnizaciones y p√©rdidas de productividad, justificando la inversi√≥n en seguridad.
            </div>
        </section>
    `;
    
    return html;
}

// NUEVA SECCI√ìN: Explicaci√≥n de la metodolog√≠a
function generarSeccionMetodologia() {
    return `
        <section class="mb-12 p-6 bg-white rounded-xl shadow-lg border-l-4 border-accent-blue">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <span class="text-accent-blue mr-2">üî¨</span> Metodolog√≠a Estad√≠stica
            </h2>
            
            <div class="space-y-6">
                <div class="p-5 bg-gray-50 rounded-lg border-l-4 border-success-dark">
                    <h3 class="text-lg font-bold text-success-dark mb-3">‚úì Distribuci√≥n Log-normal para Clasificaci√≥n</h3>
                    <p class="text-gray-700 text-sm mb-2">Para clasificar tu TFCPSI y calcular percentiles, utilizamos la <strong>distribuci√≥n Log-normal</strong> porque:</p>
                    <ul class="list-disc list-inside text-sm text-gray-600 space-y-1 ml-4">
                        <li>Las tasas de frecuencia son <strong>valores positivos continuos</strong></li>
                        <li>Presentan <strong>asimetr√≠a a la derecha</strong> (pocas empresas con tasas muy altas)</li>
                        <li>Es el modelo est√°ndar en <strong>seguridad ocupacional</strong></li>
                        <li>Pruebas estad√≠sticas confirman que se ajusta mejor que Gamma (p-valor KS = 0.98)</li>
                    </ul>
                    <p class="text-xs text-gray-500 mt-3"><strong>Par√°metros estimados:</strong> Œº = ${stats.muLog.toFixed(4)}, œÉ = ${stats.sigmaLog.toFixed(4)}</p>
                </div>

                <div class="p-5 bg-gray-50 rounded-lg border-l-4 border-accent-blue">
                    <h3 class="text-lg font-bold text-accent-blue mb-3">‚úì Modelo Poisson para Proyecci√≥n de Accidentes</h3>
                    <p class="text-gray-700 text-sm mb-2">Para proyectar el <strong>n√∫mero de accidentes futuros</strong>, utilizamos el <strong>modelo Poisson</strong> porque:</p>
                    <ul class="list-disc list-inside text-sm text-gray-600 space-y-1 ml-4">
                        <li>Modela <strong>conteos de eventos raros</strong> en un per√≠odo de tiempo</li>
                        <li>Permite calcular <strong>intervalos de confianza</strong> para la proyecci√≥n</li>
                        <li>Es apropiado para <strong>predecir accidentes</strong> dado un volumen de horas trabajadas</li>
                    </ul>
                    <p class="text-xs text-gray-500 mt-3"><strong>Par√°metro Œª:</strong> (TFCPSI √ó HHT) / 1,000,000</p>
                </div>

                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-md">
                    <h4 class="font-bold text-blue-800 mb-2">Diferencia clave: ¬øPor qu√© dos distribuciones?</h4>
                    <p class="text-sm text-blue-900">
                        <strong>Log-normal</strong> describe el <strong>comportamiento de las tasas</strong> entre empresas (benchmarking).
                        <br>
                        <strong>Poisson</strong> predice el <strong>n√∫mero de eventos</strong> en el tiempo (proyecci√≥n).
                        <br><br>
                        Ambos son complementarios y correctos para sus respectivos usos.
                    </p>
                </div>
            </div>
        </section>
    `;
}

// ============================================
// MENSAJE DE CONSOLA
// ============================================

console.log("===============================================");
console.log("CALCULADORA CIER 2025 - VERSI√ìN CORREGIDA");
console.log("Distribuci√≥n Log-normal implementada ‚úì");
console.log("Intervalos de confianza Poisson ‚úì");
console.log("===============================================");

    </script>
</body>
</html>








